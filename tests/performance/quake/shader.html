<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width">
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <link rel="stylesheet" type="text/css" href="../benchmark.css">
        <title>Benchmark - Quake (E1M1) with per-pixel shading - Retro n-gon renderer</title>
    </head>
    <body>
        <script src="../../../distributable/rngon.global.js"></script>
        <script type="module">
            import {benchmark} from "../benchmark.js";

            benchmark("./quake/assets/e1m1.rngon-model.js", {
                renderOptions: {
                    cameraPosition: Rngon.vector(500, 30, 400),
                    cameraDirection: Rngon.vector(-20, 197, 0),
                    fov: 60,
                    nearPlane: 2,
                    farPlane: 5000,
                    useFragmentBuffer: true,
                    fragments: {
                        ngon: true,
                        worldX: true,
                        worldY: true,
                        worldZ: true,
                        shade: true,
                    },
                    lights: [
                        Rngon.light(1.5, Rngon.vector(409, 115, 758), {reach: 350}),
                        Rngon.light(2, Rngon.vector(481, 182, 113), {reach: 450}),
                    ],
                },
                renderPipeline: {
                    pixelShader: perpixel_lighter,
                },
                modelOptions: {
                    vertexShading: "none",
                },
            });

            function perpixel_lighter(renderState)
            {
                const {width, height, data:pixels} = renderState.pixelBuffer;
                const fragments = renderState.fragmentBuffer.data;
                const lights = renderState.lights;
                const lightDirection = Rngon.vector();

                for (let i = 0; i < (width * height); i++)
                {
                    const thisFragment = fragments[i];
                    const thisNgon = (thisFragment.ngon || null);

                    if (!thisNgon)
                    {
                        continue;
                    }

                    let strongestShade = 0;

                    for (const light of lights)
                    {
                        const distance = (
                            ((thisFragment.worldX - light.position.x)**2) +
                            ((thisFragment.worldY - light.position.y)**2) +
                            ((thisFragment.worldZ - light.position.z)**2)
                        );

                        const distanceMul = Math.max(0, Math.min(1, (1 - (distance / (light.reach * light.reach)))));

                        if ((thisFragment.shade > 0) && (distanceMul > 0))
                        {
                            lightDirection.x = (light.position.x - thisFragment.worldX);
                            lightDirection.y = (light.position.y - thisFragment.worldY);
                            lightDirection.z = (light.position.z - thisFragment.worldZ);
                            Rngon.vector.normalize(lightDirection);

                            const shadeMul = Math.max(0, Math.min(1, Rngon.vector.dot(thisNgon.normal, lightDirection)));

                            strongestShade = Math.max(strongestShade, (distanceMul * shadeMul * light.intensity));
                        }
                    }

                    pixels[(i * 4) + 0] *= strongestShade;
                    pixels[(i * 4) + 1] *= strongestShade;
                    pixels[(i * 4) + 2] *= strongestShade;
                }
            }
        </script>
    </body>
</html>
