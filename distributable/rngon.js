(()=>{var e={962:()=>{if("function"!=typeof importScripts){class e{#e;#t;#r;data;constructor(e,t){if(isNaN(e)||isNaN(t))throw new Error("This interface supports only numeric 'width' and 'height' as arguments.");this.#t=e,this.#r=t,this.data=new Array(e*t),this.palette=[[0,0,0,0]]}get palette(){return this.#e}set palette(e){if(!Array.isArray(e))throw new Error("The palette must be an array.");if(e.length<1)throw new Error("A palette must consist of at least one color.");if(!e.every((e=>Array.isArray(e))))throw new Error("Each entry in the palette must be a sub-array of color channel values.");e.forEach((e=>{e.length=4,void 0===e[3]&&(e[3]=255)}));const t={byte:e,dword:new Uint32Array(e.map((e=>e[3]<<24|e[2]<<16|e[1]<<8|e[0])))};this.#e=new Proxy(t,{set:(e,t,r)=>(e.byte[t]=r,this.palette=e.byte,!0),get:(e,t)=>e[t]||e.byte[t]})}get width(){return this.#t}get height(){return this.#r}get colorSpace(){return"indexed"}}class t{#n;#i;#t;#r;constructor(e){if(!(e instanceof CanvasRenderingContext2D))throw new Error("CanvasRenderingContextIndexed requires an instance of CanvasRenderingContext2D as an argument.");if(this.#n=e,this.#t=this.#n.canvas.width,this.#r=this.#n.canvas.height,this.#i=this.#n.createImageData(this.#t,this.#r),this.#i.data.fill(0),isNaN(this.#t)||isNaN(this.#r)||this.#r<1||this.#t<1)throw new Error("Invalid context resolution.")}createImageData(t=this.#t,r=this.#r){if(t instanceof ImageData)throw new Error("This interface supports only 'width' and 'height' as arguments.");if(t!==this.#t||r!==this.#r)throw new Error("This interface can only create images whose resolution matches the size of the canvas.");return new e(t,r)}getImageData(){return this.#i}putImageData(t){if(!(t instanceof e))throw new Error("Only images of type IndexedImageData can be rendered.");if(t.width!==this.#t||t.height!==this.#r)throw new Error("Mismatched image resolution: images must be the size of the canvas.");{const e=t.palette.dword,r=new Uint32Array(this.#i.data.buffer);for(let n=0;n<t.data.length;n++)r[n]=e[t.data[n]]}this.#n.putImageData(this.#i,0,0)}}class r extends HTMLCanvasElement{#a;#o;constructor(){super()}static get observedAttributes(){return["width","height"]}attributeChangedCallback(e,r,n){r!=n&&["width","height"].includes(e)&&(this.#a=super.getContext("2d"),this.#o=new t(this.#a))}getContext(e="2d"){if("2d"!==e)throw new Error("This interface only supports the '2d' context type.");return this.#o}}window.IndexedImageData=e,window.CanvasRenderingContextIndexed=t,window.HTMLPalettedCanvasElement=r,customElements.define("paletted-canvas",r,{extends:"canvas"})}}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var a=t[n]={exports:{}};return e[n](a,a.exports,r),a.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var n={};(()=>{"use strict";function e(e,t){e||i(t)}function t(e,t,r){return e+r*(t-e)}function i(e=""){throw Error(e)}function a(e,t){return Math.floor(parseInt(window.getComputedStyle(e).getPropertyValue("width"))*t)}function o(e,t){return Math.floor(parseInt(window.getComputedStyle(e).getPropertyValue("height"))*t)}function l(t=0,r=0,n=0){return e?.("number"==typeof t&&"number"==typeof r&&"number"==typeof n,"Expected numbers as parameters to the vector factory."),{x:t,y:r,z:n}}function s(t=0,r=0,n=0,i=255){return e?.(t>=0&&t<=255&&r>=0&&r<=255&&n>=0&&n<=255&&i>=0&&i<=255,"The given color values are out of range."),Object.freeze({red:t,green:r,blue:n,alpha:i,unitRange:Object.freeze({red:t/255,green:r/255,blue:n/255,alpha:i/255})})}function d(e={}){return{...d.default,...e}}function h(t=0,r=0,n=0,i=0,a=0,o=1,l=1,s=t,d=r,h=n){return e?.("number"==typeof t&&"number"==typeof r&&"number"==typeof n&&"number"==typeof o&&"number"==typeof i&&"number"==typeof a&&"number"==typeof s&&"number"==typeof d&&"number"==typeof h,"Expected numbers as parameters to the vertex factory."),{x:t,y:r,z:n,u:i,v:a,w:o,shade:l,worldX:s,worldY:d,worldZ:h}}function c(t=[h()],r=d(),n=l(0,1,0)){e?.(t instanceof Array,"Expected an array of vertices to make an ngon."),e?.(r instanceof Object,"Expected an object containing user-supplied options."),r=d(r),Array.isArray(n)||(n=new Array(t.length).fill().map((e=>l(n.x,n.y,n.z))));const i=n.reduce(((e,t)=>(e.x+=t.x,e.y+=t.y,e.z+=t.z,e)),l(0,0,0));l.normalize(i);{const e=t.map((e=>e.u)).some((e=>e<0)),r=t.map((e=>e.v)).some((e=>e<0));if(e||r)for(const n of t)e&&0===n.u&&(n.u=-Number.EPSILON),r&&0===n.v&&(n.v=-Number.EPSILON)}return{vertices:t,vertexNormals:n,normal:i,material:r,mipLevel:0}}r.r(n),r.d(n,{Rngon:()=>X}),r(962),l.transform=function(t,r=[]){e?.(16===r.length,"Expected a 4 x 4 matrix to transform the vector by.");const n=r[0]*t.x+r[4]*t.y+r[8]*t.z,i=r[1]*t.x+r[5]*t.y+r[9]*t.z,a=r[2]*t.x+r[6]*t.y+r[10]*t.z;t.x=n,t.y=i,t.z=a},l.normalize=function(e){const t=e.x*e.x+e.y*e.y+e.z*e.z;if(0!=t&&1!=t){const r=1/Math.sqrt(t);e.x*=r,e.y*=r,e.z*=r}},l.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},l.cross=function(e,t){const r=l();return r.x=e.y*t.z-e.z*t.y,r.y=e.z*t.x-e.x*t.z,r.z=e.x*t.y-e.y*t.x,r},l.invert=function(e){e.x*=-1,e.y*=-1,e.z*=-1},d.default={color:s(255,255,255,255),wireframeColor:s(0,0,0,255),texture:null,textureMapping:"ortho",textureFiltering:"none",uvWrapping:"repeat",vertexShading:"none",renderVertexShade:!0,ambientLightLevel:0,hasWireframe:!1,hasFill:!0,isTwoSided:!0,isInScreenSpace:!1,allowAlphaReject:!1,allowAlphaBlend:!1},h.transform=function(t,r=[]){e?.(16===r.length,"Expected a 4 x 4 matrix to transform the vertex by.");const n=r[0]*t.x+r[4]*t.y+r[8]*t.z+r[12]*t.w,i=r[1]*t.x+r[5]*t.y+r[9]*t.z+r[13]*t.w,a=r[2]*t.x+r[6]*t.y+r[10]*t.z+r[14]*t.w,o=r[3]*t.x+r[7]*t.y+r[11]*t.z+r[15]*t.w;t.x=n,t.y=i,t.z=a,t.w=o},h.perspective_divide=function(e){e.x/=e.w,e.y/=e.w},c.perspective_divide=function(e){for(const t of e.vertices)h.perspective_divide(t)},c.transform=function(e,t){for(const r of e.vertices)h.transform(r,t)};const u=["x","y","z"],f=[1,-1];c.clip_to_viewport=function(e){for(const r of u)for(const n of f){if(!e.vertices.length)break;if(1==e.vertices.length){if(e.vertices[0].x<=e.vertices[0].w&&-e.vertices[0].x<=e.vertices[0].w&&e.vertices[0].y<=e.vertices[0].w&&-e.vertices[0].y<=e.vertices[0].w&&e.vertices[0].z<=e.vertices[0].w&&-e.vertices[0].z<=e.vertices[0].w)break;e.vertices.length=0;break}let i=e.vertices[e.vertices.length-(2==e.vertices.length?2:1)],a=i[r]*n,o=a<=i.w,l=0,s=e.vertices.length;for(let d=0;d<s;d++){const c=e.vertices[d][r]*n,u=c<=e.vertices[d].w;if(u^o){const r=(i.w-a)/(i.w-a-(e.vertices[d].w-c));e.vertices[s+l++]=h(t(i.x,e.vertices[d].x,r),t(i.y,e.vertices[d].y,r),t(i.z,e.vertices[d].z,r),t(i.u,e.vertices[d].u,r),t(i.v,e.vertices[d].v,r),t(i.w,e.vertices[d].w,r),t(i.shade,e.vertices[d].shade,r),t(i.worldX,e.vertices[d].worldX,r),t(i.worldY,e.vertices[d].worldY,r),t(i.worldZ,e.vertices[d].worldZ,r))}u&&(e.vertices[s+l++]=e.vertices[d]),i=e.vertices[d],a=c,o=u}e.vertices.splice(0,s)}};const p={enabled:[[[.25,0],[.5,.75]],[[.75,.5],[0,.25]]],disabled:[[[0,0],[0,0]],[[0,0],[0,0]]]};function g({renderState:e,ngonIdx:r,leftEdges:n,rightEdges:a,numLeftEdges:o,numRightEdges:l,pixelBuffer32:s}){if(!o||!l)return!0;const d=e.ngonCache.ngons[r],h=e.usePalette,c=e.useFragmentBuffer,u=e.fragmentBuffer.data,f=e.useDepthBuffer?e.depthBuffer.data:null,g=e.pixelBuffer,x=g.data,m=g.width,v=d.material,w=v.texture||null,y=w&&"bilinear"===v.textureFiltering,b=w&&"dither"===v.textureFiltering?p.enabled:p.disabled;let M=null,z=0;if(w){const e=w.mipLevels.length;z=Math.max(0,Math.min(e-1,Math.round((e-1)*d.mipLevel))),M=w.mipLevels[z]}let B=0,P=0,_=n[B],C=a[P];const E=n[0].top,W=n[o-1].bottom;let D=E-1;for(;++D<W;){const e=Math.min(m,Math.max(0,Math.round(_.x))),o=Math.min(m,Math.max(0,Math.ceil(C.x))),l=o-e+1;if(l>0){const n=(C.depth-_.depth)/l;let a=_.depth-n;const d=(C.shade-_.shade)/l;let p=_.shade-d;const g=(C.u-_.u)/l;let z=_.u-g;const B=(C.v-_.v)/l;let P=_.v-B;const O=(C.invW-_.invW)/l;let X=_.invW-O;if(c)var I=(C.worldX-_.worldX)/l,A=_.worldX-I,R=(C.worldY-_.worldY)/l,L=_.worldY-R,N=(C.worldZ-_.worldZ)/l,j=_.worldZ-N;let k=e+D*m-1,T=e-1;for(;++T<o;){let o=0,m=0;a+=n,p+=d,z+=g,P+=B,X+=O,k++,c&&(A+=I,L+=R,j+=N);const _=a/X;if(f&&f[k]<=_)continue;let C,V=v.renderVertexShade?p:1,F=0,Y=0,Z=0,U=0;if(w){switch(v.textureMapping){case"affine":switch(o=z/X,m=P/X,v.uvWrapping){case"clamp":{const e=1-Number.EPSILON;o=o<0?e+o:o,m=m<0?e+m:m;const t=b[1&D][1&T];o+=t[0]/M.width,m+=t[1]/M.height,o=M.width*(o<0?0:o>e?e:o),m=M.height*(m<0?0:m>e?e:m);break}case"repeat":{const e=b[1&D][1&T];o+=e[0]/M.width,m+=e[1]/M.height,o=M.width*(o-Math.floor(o)),m=M.height*(m-Math.floor(m));const t=Math.abs(o),r=Math.abs(m),n=t-~~t,i=r-~~r;o=(o&M.width-1)+n,m=(m&M.height-1)+i;break}default:i("Unrecognized UV wrapping mode.")}break;case"affine-npot":{o=z/X,m=P/X;const e=1-Number.EPSILON;o=o<0?e+o:o,m=m<0?e+m:m;const t=b[1&D][1&T];o+=t[0]/M.width,m+=t[1]/M.height,o=M.width*(o<0?0:o>e?e:o),m=M.height*(m<0?0:m>e?e:m)}break;case"ortho":{const t=W-E,r=T-e+1,n=D-E+1,i=b[1&D][1&T];o+=i[0],m+=i[1],o=r*(M.width/l),m=n*(M.height/t),m=M.height-m;break}default:i("Unknown texture-mapping mode.")}if(C=M.pixels[~~o+~~m*M.width],!C)continue;if(v.allowAlphaReject&&255!==C.alpha)continue;if(v.allowAlphaBlend&&S.stipple(v.color.alpha,T,D))continue;U=C.index,F=C.red,Y=C.green,Z=C.blue}else{if(v.allowAlphaBlend&&S.stipple(v.color.alpha,T,D))continue;U=v.color.index,F=v.color.red*V,Y=v.color.green*V,Z=v.color.blue*V}if(h)x[k]=U;else{if(y){const e=o-(o=~~o),r=m-(m=~~m);let n=M.pixels[o+1+m*M.width]||C,i=M.pixels[o+(m+1)*M.width]||C,a=M.pixels[o+1+(m+1)*M.width]||C;255!==n.alpha&&(n=C),255!==i.alpha&&(i=C),255!==a.alpha&&(a=C);const l={red:t(F,n.red,e),green:t(Y,n.green,e),blue:t(Z,n.blue,e)},s={red:t(i.red,a.red,e),green:t(i.green,a.green,e),blue:t(i.blue,a.blue,e)};F=V*v.color.unitRange.red*t(l.red,s.red,r),Y=V*v.color.unitRange.green*t(l.green,s.green,r),Z=V*v.color.unitRange.blue*t(l.blue,s.blue,r)}else F*=V*v.color.unitRange.red,Y*=V*v.color.unitRange.green,Z*=V*v.color.unitRange.blue;if(V>1){const e=4*k;x[e+0]=F,x[e+1]=Y,x[e+2]=Z,x[e+3]=255}else s[k]=(255<<24)+(Z<<16)+(Y<<8)+~~F}if(f&&(f[k]=_),c){const e=u[k];e.ngonIdx=r,e.textureUScaled=~~o,e.textureVScaled=~~m,e.depth=a/X,e.shade=p,e.worldX=A/X,e.worldY=L/X,e.worldZ=j/X,e.w=1/X}}}_.x+=_.delta.x,_.depth+=_.delta.depth,_.shade+=_.delta.shade,_.u+=_.delta.u,_.v+=_.delta.v,_.invW+=_.delta.invW,C.x+=C.delta.x,C.depth+=C.delta.depth,C.shade+=C.delta.shade,C.u+=C.delta.u,C.v+=C.delta.v,C.invW+=C.delta.invW,c&&(_.worldX+=_.delta.worldX,_.worldY+=_.delta.worldY,_.worldZ+=_.delta.worldZ,C.worldX+=C.delta.worldX,C.worldY+=C.delta.worldY,C.worldZ+=C.delta.worldZ),D===_.bottom-1&&(_=n[++B]),D===C.bottom-1&&(C=a[++P])}return!0}function x({renderState:e,ngonIdx:t,leftEdges:r,rightEdges:n,numLeftEdges:i,numRightEdges:a,pixelBuffer32:o}){const l=e.ngonCache.ngons[t],s=e.usePalette,d=e.pixelBuffer,h=d.data,c=d.width,u=e.useDepthBuffer?e.depthBuffer.data:null,f=l.material;let p=0,g=0,x=r[p],m=n[g];if(!i||!a)return;const v=r[0].top,w=r[i-1].bottom;let y=v-1;for(;++y<w;){const e=Math.min(c,Math.max(0,Math.round(x.x))),t=Math.min(c,Math.max(0,Math.ceil(m.x))),i=t-e+1;if(i>0){const r=(m.depth-x.depth)/i;let n=x.depth-r;const a=(m.shade-x.shade)/i;let l=x.shade-a;const d=(m.invW-x.invW)/i;let p=x.invW-d,g=e+y*c-1,v=e-1;for(;++v<t;){n+=r,l+=a,p+=d,g++;const e=n/p;if(!(u[g]<=e)){if(s)h[g]=f.color.index;else{const e=f.renderVertexShade?l:1,t=f.color.red*e,r=f.color.green*e,n=f.color.blue*e;if(e>1){const e=4*g;h[e+0]=t,h[e+1]=r,h[e+2]=n,h[e+3]=255}else o[g]=(255<<24)+(n<<16)+(r<<8)+~~t}u[g]=e}}}x.x+=x.delta.x,x.depth+=x.delta.depth,x.shade+=x.delta.shade,x.invW+=x.delta.invW,m.x+=m.delta.x,m.depth+=m.delta.depth,m.shade+=m.delta.shade,m.invW+=m.delta.invW,y===x.bottom-1&&(x=r[++p]),y===m.bottom-1&&(m=n[++g])}return!0}function m({renderState:e,ngonIdx:t,leftEdges:r,rightEdges:n,numLeftEdges:a,numRightEdges:o,pixelBuffer32:l}){if(!a||!o)return!0;const s=e.ngonCache.ngons[t],d=e.pixelBuffer,h=d.data,c=d.width,u=e.useDepthBuffer?e.depthBuffer.data:null,f=s.material,p=f.texture||null;let g=null,x=0;const m=p.mipLevels.length;x=Math.max(0,Math.min(m-1,Math.round((m-1)*s.mipLevel))),g=p.mipLevels[x];let v=0,w=0,y=r[v],b=n[w];const M=r[0].top,z=r[a-1].bottom;let B=M-1;for(;++B<z;){const e=Math.min(c,Math.max(0,Math.round(y.x))),t=Math.min(c,Math.max(0,Math.ceil(b.x))),a=t-e+1;if(a>0){const r=(b.depth-y.depth)/a;let n=y.depth-r;const o=(b.shade-y.shade)/a;let s=y.shade-o;const d=(b.u-y.u)/a;let p=y.u-d;const x=(b.v-y.v)/a;let m=y.v-x;const v=(b.invW-y.invW)/a;let w=y.invW-v,M=e+B*c-1,z=e-1;for(;++z<t;){n+=r,s+=o,p+=d,m+=x,w+=v,M++;const e=n/w;if(u[M]<=e)continue;let t=p/w,a=m/w;switch(f.uvWrapping){case"clamp":{const e=1-Number.EPSILON;t=t<0?e+t:t,a=a<0?e+a:a,t=g.width*(t<0?0:t>e?e:t),a=g.height*(a<0?0:a>e?e:a);break}case"repeat":t=g.width*(t-Math.floor(t)),a=g.height*(a-Math.floor(a)),t&=g.width-1,a&=g.height-1;break;default:i("Unrecognized UV wrapping mode.")}const c=g.pixels[~~t+~~a*g.width];{const t=f.renderVertexShade?s:1,r=c.red*t,n=c.green*t,i=c.blue*t;if(t>1){const e=4*M;h[e+0]=r,h[e+1]=n,h[e+2]=i,h[e+3]=255}else l[M]=(255<<24)+(i<<16)+(n<<8)+~~r;u[M]=e}}}y.x+=y.delta.x,y.depth+=y.delta.depth,y.shade+=y.delta.shade,y.u+=y.delta.u,y.v+=y.delta.v,y.invW+=y.delta.invW,b.x+=b.delta.x,b.depth+=b.delta.depth,b.shade+=b.delta.shade,b.u+=b.delta.u,b.v+=b.delta.v,b.invW+=b.delta.invW,B===y.bottom-1&&(y=r[++v]),B===b.bottom-1&&(b=n[++w])}return!0}function v({renderState:e,ngonIdx:r,leftEdges:n,rightEdges:a,numLeftEdges:o,numRightEdges:l,pixelBuffer32:s}){if(!o||!l)return!0;const d=e.ngonCache.ngons[r],h=e.usePalette,c=e.pixelBuffer,u=c.data,f=c.width,p=e.useDepthBuffer?e.depthBuffer.data:null,g=d.material,x=g.texture||null,m=x&&"bilinear"===g.textureFiltering;let v=null,w=0;const y=x.mipLevels.length;w=Math.max(0,Math.min(y-1,Math.round((y-1)*d.mipLevel))),v=x.mipLevels[w];let b=0,M=0,z=n[b],B=a[M];const S=n[0].top,P=n[o-1].bottom;let _=S-1;for(;++_<P;){const e=Math.min(f,Math.max(0,Math.round(z.x))),r=Math.min(f,Math.max(0,Math.ceil(B.x))),o=r-e+1;if(o>0){const n=(B.depth-z.depth)/o;let a=z.depth-n;const l=(B.shade-z.shade)/o;let d=z.shade-l;const c=(B.u-z.u)/o;let x=z.u-c;const w=(B.v-z.v)/o;let y=z.v-w;const b=(B.invW-z.invW)/o;let M=z.invW-b,S=e+_*f-1,P=e-1;for(;++P<r;){a+=n,d+=l,x+=c,y+=w,M+=b,S++;const e=a/M;if(p[S]<=e)continue;let r=x/M,o=y/M;switch(g.uvWrapping){case"clamp":{const e=1-Number.EPSILON;r=r<0?e+r:r,o=o<0?e+o:o,r=v.width*(r<0?0:r>e?e:r),o=v.height*(o<0?0:o>e?e:o);break}case"repeat":{r=v.width*(r-Math.floor(r)),o=v.height*(o-Math.floor(o));const e=Math.abs(r),t=Math.abs(o),n=e-~~e,i=t-~~t;r=(r&v.width-1)+n,o=(o&v.height-1)+i;break}default:i("Unrecognized UV wrapping mode.")}const f=v.pixels[~~r+~~o*v.width];if(h)u[S]=f.color.index;else{const e=g.renderVertexShade?d:1;let n=f.red,i=f.green,a=f.blue;if(m){const l=r-(r=~~r),s=o-(o=~~o);let d=v.pixels[r+1+o*v.width]||f,h=v.pixels[r+(o+1)*v.width]||f,c=v.pixels[r+1+(o+1)*v.width]||f;255!==d.alpha&&(d=f),255!==h.alpha&&(h=f),255!==c.alpha&&(c=f);const u={red:t(n,d.red,l),green:t(i,d.green,l),blue:t(a,d.blue,l)},p={red:t(h.red,c.red,l),green:t(h.green,c.green,l),blue:t(h.blue,c.blue,l)};n=e*g.color.unitRange.red*t(u.red,p.red,s),i=e*g.color.unitRange.green*t(u.green,p.green,s),a=e*g.color.unitRange.blue*t(u.blue,p.blue,s)}else n*=e*g.color.unitRange.red,i*=e*g.color.unitRange.green,a*=e*g.color.unitRange.blue;if(e>1){const e=4*S;u[e+0]=n,u[e+1]=i,u[e+2]=a,u[e+3]=255}else s[S]=(255<<24)+(a<<16)+(i<<8)+~~n}p[S]=e}}z.x+=z.delta.x,z.depth+=z.delta.depth,z.shade+=z.delta.shade,z.u+=z.delta.u,z.v+=z.delta.v,z.invW+=z.delta.invW,B.x+=B.delta.x,B.depth+=B.delta.depth,B.shade+=B.delta.shade,B.u+=B.delta.u,B.v+=B.delta.v,B.invW+=B.delta.invW,_===z.bottom-1&&(z=n[++b]),_===B.bottom-1&&(B=a[++M])}return!0}const w=500,y=new Array(w),b=new Array(w),M=new Array(w).fill().map((()=>({top:void 0,bottom:void 0,start:{x:void 0,depth:void 0,shade:void 0,u:void 0,v:void 0,invW:void 0,worldX:void 0,worldY:void 0,worldZ:void 0},delta:{}}))),z=new Array(w).fill().map((()=>({top:void 0,bottom:void 0,start:{x:void 0,depth:void 0,shade:void 0,u:void 0,v:void 0,invW:void 0,worldX:void 0,worldY:void 0,worldZ:void 0},delta:{}}))),B=(e,t)=>e.y===t.y?0:e.y<t.y?-1:1;function S(e){for(let t=0;t<e.ngonCache.count;t++){const r=e.ngonCache.ngons[t];switch(r.vertices.length){case 0:continue;case 1:S.point(e,r.vertices[0],r.material,t);break;case 2:S.line(e,r.vertices[0],r.vertices[1],r.material.color,t,!1);break;default:S.polygon(e,r,t)}}}function P(e){e.pixelBuffer.data.fill(0),e.useDepthBuffer&&e.depthBuffer.data.fill(e.depthBuffer.clearValue)}S.polygon=function(r,n=c(),i=0){e?.(n.vertices.length>=3,"Polygons must have 3 or more vertices"),e?.(n.vertices.length<w,"Overflowing the vertex buffer");const a=r.usePerspectiveInterpolation,o=r.useFragmentBuffer,l=r.useDepthBuffer?r.depthBuffer.data:null,s=r.pixelBuffer.width,d=r.pixelBuffer.height,h=r.usePalette,u=n.material,f=h?void 0:new Uint32Array(r.pixelBuffer.data.buffer);let p=0,P=0,_=0,C=0;if(function(){n.vertices.sort(B);const e=n.vertices[0],r=n.vertices[n.vertices.length-1];y[p++]=e,b[P++]=e;for(let i=1;i<n.vertices.length-1;i++){const a=t(e.x,r.x,(n.vertices[i].y-e.y)/(r.y-e.y));n.vertices[i].x>=a?b[P++]=n.vertices[i]:y[p++]=n.vertices[i]}y[p++]=r,b[P++]=r}(),function(){for(let t=1;t<p;t++)e(y[t-1],y[t],!0);for(let t=1;t<P;t++)e(b[t-1],b[t],!1);function e(e,t,n){const i=Math.min(d,Math.max(0,Math.floor(e.y))),l=Math.min(d,Math.max(0,Math.floor(t.y))),h=l-i;if(0===h)return;const c=a?e.w:1,f=a?t.w:1,p=Math.min(s,Math.max(0,Math.floor(e.x))),g=(Math.min(s,Math.max(0,Math.floor(t.x)))-p)/h,x=e.z/r.farPlaneDistance,m=x/c,v=(t.z/r.farPlaneDistance/f-x/c)/h,w=e.shade,y=(t.shade-e.shade)/h,b=u.texture?e.u:1,B=u.texture?e.v:1,S=b/c,P=((u.texture?t.u:1)/f-b/c)/h,E=B/c,W=((u.texture?t.v:1)/f-B/c)/h,D=1/c,I=(1/f-1/c)/h,A=n?M[_++]:z[C++];A.top=i,A.bottom=l,A.x=p,A.delta.x=g,A.depth=m,A.delta.depth=v,A.shade=w,A.delta.shade=y,A.u=S,A.delta.u=P,A.v=E,A.delta.v=W,A.invW=D,A.delta.invW=I,o&&(A.worldX=e.worldX/c,A.delta.worldX=(t.worldX/f-e.worldX/c)/h,A.worldY=e.worldY/c,A.delta.worldY=(t.worldY/f-e.worldY/c)/h,A.worldZ=e.worldZ/c,A.delta.worldZ=(t.worldZ/f-e.worldZ/c)/h)}}(),u.hasFill){const e={renderState:r,ngonIdx:i,leftEdges:M,rightEdges:z,numLeftEdges:_,numRightEdges:C,pixelBuffer32:f};if(!r.modules.raster_shader?.(e)){let t;t=!u.texture||!l||o||r.usePalette||u.allowAlphaReject||u.allowAlphaBlend||"affine"!==u.textureMapping||"dither"===u.textureFiltering?u.texture||!l||o||r.usePalette||u.allowAlphaReject||u.allowAlphaBlend?g:x:r.usePalette||255!==u.color.red||255!==u.color.green||255!==u.color.blue||"none"!==u.textureFiltering?v:m,t(e)}}if(r.showGlobalWireframe||u.hasWireframe){for(let e=1;e<p;e++)S.line(r,y[e-1],y[e],u.wireframeColor,i,!0);for(let e=1;e<P;e++)S.line(r,b[e-1],b[e],u.wireframeColor,i,!0)}},S.line=function(e,t=h(),r=h(),n=s(),i=0,a=!1){if(255!==n.alpha)return;const o=e.usePerspectiveInterpolation,l=e.farPlaneDistance,d=e.useFragmentBuffer,c=e.useDepthBuffer?e.depthBuffer.data:null,u=e.pixelBuffer.data,f=new Uint32Array(u.buffer),p=e.pixelBuffer.width,g=e.pixelBuffer.height,x=Math.floor(t.x),m=Math.floor(t.y),v=Math.floor(r.x),w=Math.floor(r.y);let y=Math.round(Math.sqrt((v-x)*(v-x)+(w-m)*(w-m)));const b=(v-x)/y,M=(w-m)/y;let z=x,B=m;const S=o?t.w:1,P=o?r.w:1,_=t.z/l,C=r.z/l;let E=_/S;const W=(C/P-_/S)/y;let D=t.shade/S;const I=(r.shade/P-t.shade/S)/y;let A=1/S;const R=(1/P-1/S)/y;if(d)var L=t.worldX/S,N=(r.worldX/P-t.worldX/S)/y,j=t.worldY/S,O=(r.worldY/P-t.worldY/S)/y,X=t.worldZ/S,k=(r.worldZ/P-t.worldZ/S)/y;for(;y--;)T(Math.floor(z),Math.floor(B)),z+=b,B+=M,E+=W,D+=I,A+=R,d&&(L+=N,j+=O,X+=k);function T(t,r){if(t<0||r<0||t>=p||r>=g)return;const o=t+r*p,l=E/A,s=D/A,h=n.red*s,x=n.green*s,m=n.blue*s;if(a||!c||c[o]>l){if(s>1){const e=4*o;u[e+0]=h,u[e+1]=x,u[e+2]=m,u[e+3]=255}else f[o]=(255<<24)+(m<<16)+(x<<8)+h;if(c&&!a&&(c[o]=l),d){const t=e.fragmentBuffer.data[o];t.ngonIdx=i,t.textureUScaled=void 0,t.textureVScaled=void 0,t.depth=E/A,t.shade=D/A,t.worldX=L/A,t.worldY=j/A,t.worldZ=X/A,t.w=1/A}}}},S.point=function(e,t=h(),r=d(),n=0){if(255!=r.color.alpha)return;const i=e.useFragmentBuffer,a=e.useDepthBuffer?e.depthBuffer.data:null,o=e.pixelBuffer.data,l=new Uint32Array(o.buffer),s=e.pixelBuffer.width,c=e.pixelBuffer.height,u=Math.floor(t.x),f=Math.floor(t.y),p=u+f*s;if(u<0||f<0||u>=s||f>=c)return;const g=t.z/e.farPlaneDistance,x=r.renderVertexShade?t.shade:1,m=r.texture?r.texture.pixels[0]:r.color,v=m.red*x,w=m.green*x,y=m.blue*x;if(!(a&&a[p]<=g)){if(x>1){const e=4*p;o[e+0]=v,o[e+1]=w,o[e+2]=y,o[e+3]=255}else l[p]=(255<<24)+(y<<16)+(w<<8)+v;if(a&&(a[p]=g),i){const r=e.fragmentBuffer.data[p];r.ngonIdx=n,r.textureUScaled=0,r.textureVScaled=0,r.depth=g,r.shade=x,r.worldX=t.worldX,r.worldY=t.worldY,r.worldZ=t.worldZ,r.w=t.w}}},S.stipple=function(){const e=[{width:8,height:6,pixels:[0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},{width:4,height:4,pixels:[0,1,0,1,1,1,1,1,1,0,1,0,1,1,1,1]},{width:2,height:2,pixels:[1,0,0,1]}];for(let t=e.length-2;t>=0;t--)e.push({width:e[t].width,height:e[t].height,pixels:e[t].pixels.map((e=>Number(!e)))});return function(t,r,n){if(t<=0)return!0;if(t>=255)return!1;{const i=Math.floor(t/(256/e.length)),a=e[i],o=r%a.width+n%a.height*a.width;if(a.pixels[o])return!0}return!1}}();const _=[0,.0061359,.0122715,.0184067,.0245412,.0306748,.0368072,.0429383,.0490677,.0551952,.0613207,.0674439,.0735646,.0796824,.0857973,.091909,.0980171,.1041216,.1102222,.1163186,.1224107,.1284981,.1345807,.1406582,.1467305,.1527972,.1588581,.1649131,.1709619,.1770042,.1830399,.1890687,.1950903,.2011046,.2071114,.2131103,.2191012,.2250839,.2310581,.2370236,.2429802,.2489276,.2548657,.2607941,.2667128,.2726214,.2785197,.2844075,.2902847,.2961509,.3020059,.3078496,.3136817,.319502,.3253103,.3311063,.3368899,.3426607,.3484187,.3541635,.359895,.365613,.3713172,.3770074,.3826834,.388345,.393992,.3996242,.4052413,.4108432,.4164296,.4220003,.4275551,.4330938,.4386162,.4441221,.4496113,.4550836,.4605387,.4659765,.4713967,.4767992,.4821838,.4875502,.4928982,.4982277,.5035384,.5088301,.5141027,.519356,.5245897,.5298036,.5349976,.5401715,.545325,.550458,.5555702,.5606616,.5657318,.5707807,.5758082,.580814,.5857979,.5907597,.5956993,.6006165,.605511,.6103828,.6152316,.6200572,.6248595,.6296382,.6343933,.6391244,.6438315,.6485144,.6531728,.6578067,.6624158,.6669999,.671559,.6760927,.680601,.6850837,.6895405,.6939715,.6983762,.7027547,.7071068,.7114322,.7157308,.7200025,.7242471,.7284644,.7326543,.7368166,.7409511,.7450578,.7491364,.7531868,.7572088,.7612024,.7651673,.7691033,.7730105,.7768885,.7807372,.7845566,.7883464,.7921066,.7958369,.7995373,.8032075,.8068476,.8104572,.8140363,.8175848,.8211025,.8245893,.828045,.8314696,.8348629,.8382247,.841555,.8448536,.8481203,.8513552,.854558,.8577286,.8608669,.8639729,.8670462,.870087,.873095,.8760701,.8790122,.8819213,.8847971,.8876396,.8904487,.8932243,.8959662,.8986745,.9013488,.9039893,.9065957,.909168,.911706,.9142098,.9166791,.9191139,.921514,.9238795,.9262102,.9285061,.930767,.9329928,.9351835,.937339,.9394592,.9415441,.9435935,.9456073,.9475856,.9495282,.951435,.953306,.9551412,.9569403,.9587035,.9604305,.9621214,.9637761,.9653944,.9669765,.9685221,.9700313,.9715039,.97294,.9743394,.9757021,.9770281,.9783174,.9795698,.9807853,.9819639,.9831055,.9842101,.9852776,.9863081,.9873014,.9882576,.9891765,.9900582,.9909026,.9917098,.9924795,.9932119,.993907,.9945646,.9951847,.9957674,.9963126,.9968203,.9972905,.9977231,.9981181,.9984756,.9987955,.9990777,.9993224,.9995294,.9996988,.9998306,.9999247,.9999812,1,.9999812,.9999247,.9998306,.9996988,.9995294,.9993224,.9990777,.9987955,.9984756,.9981181,.9977231,.9972905,.9968203,.9963126,.9957674,.9951847,.9945646,.993907,.9932119,.9924795,.9917098,.9909026,.9900582,.9891765,.9882576,.9873014,.9863081,.9852776,.9842101,.9831055,.9819639,.9807853,.9795698,.9783174,.9770281,.9757021,.9743394,.97294,.9715039,.9700313,.9685221,.9669765,.9653944,.9637761,.9621214,.9604305,.9587035,.9569403,.9551412,.953306,.951435,.9495282,.9475856,.9456073,.9435935,.9415441,.9394592,.937339,.9351835,.9329928,.930767,.9285061,.9262102,.9238795,.921514,.9191139,.9166791,.9142098,.911706,.909168,.9065957,.9039893,.9013488,.8986745,.8959662,.8932243,.8904487,.8876396,.8847971,.8819213,.8790122,.8760701,.873095,.870087,.8670462,.8639729,.8608669,.8577286,.854558,.8513552,.8481203,.8448536,.841555,.8382247,.8348629,.8314696,.828045,.8245893,.8211025,.8175848,.8140363,.8104572,.8068476,.8032075,.7995373,.7958369,.7921066,.7883464,.7845566,.7807372,.7768885,.7730105,.7691033,.7651673,.7612024,.7572088,.7531868,.7491364,.7450578,.7409511,.7368166,.7326543,.7284644,.7242471,.7200025,.7157308,.7114322,.7071068,.7027547,.6983762,.6939715,.6895405,.6850837,.680601,.6760927,.671559,.6669999,.6624158,.6578067,.6531728,.6485144,.6438315,.6391244,.6343933,.6296382,.6248595,.6200572,.6152316,.6103828,.605511,.6006165,.5956993,.5907597,.5857979,.580814,.5758082,.5707807,.5657318,.5606616,.5555702,.550458,.545325,.5401715,.5349976,.5298036,.5245897,.519356,.5141027,.5088301,.5035384,.4982277,.4928982,.4875502,.4821838,.4767992,.4713967,.4659765,.4605387,.4550836,.4496113,.4441221,.4386162,.4330938,.4275551,.4220003,.4164296,.4108432,.4052413,.3996242,.393992,.388345,.3826834,.3770074,.3713172,.365613,.359895,.3541635,.3484187,.3426607,.3368899,.3311063,.3253103,.319502,.3136817,.3078496,.3020059,.2961509,.2902847,.2844075,.2785197,.2726214,.2667128,.2607941,.2548657,.2489276,.2429802,.2370236,.2310581,.2250839,.2191012,.2131103,.2071114,.2011046,.1950903,.1890687,.1830399,.1770042,.1709619,.1649131,.1588581,.1527972,.1467305,.1406582,.1345807,.1284981,.1224107,.1163186,.1102222,.1041216,.0980171,.091909,.0857973,.0796824,.0735646,.0674439,.0613207,.0551952,.0490677,.0429383,.0368072,.0306748,.0245412,.0184067,.0122715,.0061359,0,-.0061359,-.0122715,-.0184067,-.0245412,-.0306748,-.0368072,-.0429383,-.0490677,-.0551952,-.0613207,-.0674439,-.0735646,-.0796824,-.0857973,-.091909,-.0980171,-.1041216,-.1102222,-.1163186,-.1224107,-.1284981,-.1345807,-.1406582,-.1467305,-.1527972,-.1588581,-.1649131,-.1709619,-.1770042,-.1830399,-.1890687,-.1950903,-.2011046,-.2071114,-.2131103,-.2191012,-.2250839,-.2310581,-.2370236,-.2429802,-.2489276,-.2548657,-.2607941,-.2667128,-.2726214,-.2785197,-.2844075,-.2902847,-.2961509,-.3020059,-.3078496,-.3136817,-.319502,-.3253103,-.3311063,-.3368899,-.3426607,-.3484187,-.3541635,-.359895,-.365613,-.3713172,-.3770074,-.3826834,-.388345,-.393992,-.3996242,-.4052413,-.4108432,-.4164296,-.4220003,-.4275551,-.4330938,-.4386162,-.4441221,-.4496113,-.4550836,-.4605387,-.4659765,-.4713967,-.4767992,-.4821838,-.4875502,-.4928982,-.4982277,-.5035384,-.5088301,-.5141027,-.519356,-.5245897,-.5298036,-.5349976,-.5401715,-.545325,-.550458,-.5555702,-.5606616,-.5657318,-.5707807,-.5758082,-.580814,-.5857979,-.5907597,-.5956993,-.6006165,-.605511,-.6103828,-.6152316,-.6200572,-.6248595,-.6296382,-.6343933,-.6391244,-.6438315,-.6485144,-.6531728,-.6578067,-.6624158,-.6669999,-.671559,-.6760927,-.680601,-.6850837,-.6895405,-.6939715,-.6983762,-.7027547,-.7071068,-.7114322,-.7157308,-.7200025,-.7242471,-.7284644,-.7326543,-.7368166,-.7409511,-.7450578,-.7491364,-.7531868,-.7572088,-.7612024,-.7651673,-.7691033,-.7730105,-.7768885,-.7807372,-.7845566,-.7883464,-.7921066,-.7958369,-.7995373,-.8032075,-.8068476,-.8104572,-.8140363,-.8175848,-.8211025,-.8245893,-.828045,-.8314696,-.8348629,-.8382247,-.841555,-.8448536,-.8481203,-.8513552,-.854558,-.8577286,-.8608669,-.8639729,-.8670462,-.870087,-.873095,-.8760701,-.8790122,-.8819213,-.8847971,-.8876396,-.8904487,-.8932243,-.8959662,-.8986745,-.9013488,-.9039893,-.9065957,-.909168,-.911706,-.9142098,-.9166791,-.9191139,-.921514,-.9238795,-.9262102,-.9285061,-.930767,-.9329928,-.9351835,-.937339,-.9394592,-.9415441,-.9435935,-.9456073,-.9475856,-.9495282,-.951435,-.953306,-.9551412,-.9569403,-.9587035,-.9604305,-.9621214,-.9637761,-.9653944,-.9669765,-.9685221,-.9700313,-.9715039,-.97294,-.9743394,-.9757021,-.9770281,-.9783174,-.9795698,-.9807853,-.9819639,-.9831055,-.9842101,-.9852776,-.9863081,-.9873014,-.9882576,-.9891765,-.9900582,-.9909026,-.9917098,-.9924795,-.9932119,-.993907,-.9945646,-.9951847,-.9957674,-.9963126,-.9968203,-.9972905,-.9977231,-.9981181,-.9984756,-.9987955,-.9990777,-.9993224,-.9995294,-.9996988,-.9998306,-.9999247,-.9999812,-1,-.9999812,-.9999247,-.9998306,-.9996988,-.9995294,-.9993224,-.9990777,-.9987955,-.9984756,-.9981181,-.9977231,-.9972905,-.9968203,-.9963126,-.9957674,-.9951847,-.9945646,-.993907,-.9932119,-.9924795,-.9917098,-.9909026,-.9900582,-.9891765,-.9882576,-.9873014,-.9863081,-.9852776,-.9842101,-.9831055,-.9819639,-.9807853,-.9795698,-.9783174,-.9770281,-.9757021,-.9743394,-.97294,-.9715039,-.9700313,-.9685221,-.9669765,-.9653944,-.9637761,-.9621214,-.9604305,-.9587035,-.9569403,-.9551412,-.953306,-.951435,-.9495282,-.9475856,-.9456073,-.9435935,-.9415441,-.9394592,-.937339,-.9351835,-.9329928,-.930767,-.9285061,-.9262102,-.9238795,-.921514,-.9191139,-.9166791,-.9142098,-.911706,-.909168,-.9065957,-.9039893,-.9013488,-.8986745,-.8959662,-.8932243,-.8904487,-.8876396,-.8847971,-.8819213,-.8790122,-.8760701,-.873095,-.870087,-.8670462,-.8639729,-.8608669,-.8577286,-.854558,-.8513552,-.8481203,-.8448536,-.841555,-.8382247,-.8348629,-.8314696,-.828045,-.8245893,-.8211025,-.8175848,-.8140363,-.8104572,-.8068476,-.8032075,-.7995373,-.7958369,-.7921066,-.7883464,-.7845566,-.7807372,-.7768885,-.7730105,-.7691033,-.7651673,-.7612024,-.7572088,-.7531868,-.7491364,-.7450578,-.7409511,-.7368166,-.7326543,-.7284644,-.7242471,-.7200025,-.7157308,-.7114322,-.7071068,-.7027547,-.6983762,-.6939715,-.6895405,-.6850837,-.680601,-.6760927,-.671559,-.6669999,-.6624158,-.6578067,-.6531728,-.6485144,-.6438315,-.6391244,-.6343933,-.6296382,-.6248595,-.6200572,-.6152316,-.6103828,-.605511,-.6006165,-.5956993,-.5907597,-.5857979,-.580814,-.5758082,-.5707807,-.5657318,-.5606616,-.5555702,-.550458,-.545325,-.5401715,-.5349976,-.5298036,-.5245897,-.519356,-.5141027,-.5088301,-.5035384,-.4982277,-.4928982,-.4875502,-.4821838,-.4767992,-.4713967,-.4659765,-.4605387,-.4550836,-.4496113,-.4441221,-.4386162,-.4330938,-.4275551,-.4220003,-.4164296,-.4108432,-.4052413,-.3996242,-.393992,-.388345,-.3826834,-.3770074,-.3713172,-.365613,-.359895,-.3541635,-.3484187,-.3426607,-.3368899,-.3311063,-.3253103,-.319502,-.3136817,-.3078496,-.3020059,-.2961509,-.2902847,-.2844075,-.2785197,-.2726214,-.2667128,-.2607941,-.2548657,-.2489276,-.2429802,-.2370236,-.2310581,-.2250839,-.2191012,-.2131103,-.2071114,-.2011046,-.1950903,-.1890687,-.1830399,-.1770042,-.1709619,-.1649131,-.1588581,-.1527972,-.1467305,-.1406582,-.1345807,-.1284981,-.1224107,-.1163186,-.1102222,-.1041216,-.0980171,-.091909,-.0857973,-.0796824,-.0735646,-.0674439,-.0613207,-.0551952,-.0490677,-.0429383,-.0368072,-.0306748,-.0245412,-.0184067,-.0122715,-.0061359,-0,.0061359,.0122715,.0184067,.0245412,.0306748,.0368072,.0429383,.0490677,.0551952,.0613207,.0674439,.0735646,.0796824,.0857973,.091909,.0980171,.1041216,.1102222,.1163186,.1224107,.1284981,.1345807,.1406582,.1467305,.1527972,.1588581,.1649131,.1709619,.1770042,.1830399,.1890687,.1950903,.2011046,.2071114,.2131103,.2191012,.2250839,.2310581,.2370236,.2429802,.2489276,.2548657,.2607941,.2667128,.2726214,.2785197,.2844075,.2902847,.2961509,.3020059,.3078496,.3136817,.319502,.3253103,.3311063,.3368899,.3426607,.3484187,.3541635,.359895,.365613,.3713172,.3770074,.3826834,.388345,.393992,.3996242,.4052413,.4108432,.4164296,.4220003,.4275551,.4330938,.4386162,.4441221,.4496113,.4550836,.4605387,.4659765,.4713967,.4767992,.4821838,.4875502,.4928982,.4982277,.5035384,.5088301,.5141027,.519356,.5245897,.5298036,.5349976,.5401715,.545325,.550458,.5555702,.5606616,.5657318,.5707807,.5758082,.580814,.5857979,.5907597,.5956993,.6006165,.605511,.6103828,.6152316,.6200572,.6248595,.6296382,.6343933,.6391244,.6438315,.6485144,.6531728,.6578067,.6624158,.6669999,.671559,.6760927,.680601,.6850837,.6895405,.6939715,.6983762,.7027547,.7071068,.7114322,.7157308,.7200025,.7242471,.7284644,.7326543,.7368166,.7409511,.7450578,.7491364,.7531868,.7572088,.7612024,.7651673,.7691033,.7730105,.7768885,.7807372,.7845566,.7883464,.7921066,.7958369,.7995373,.8032075,.8068476,.8104572,.8140363,.8175848,.8211025,.8245893,.828045,.8314696,.8348629,.8382247,.841555,.8448536,.8481203,.8513552,.854558,.8577286,.8608669,.8639729,.8670462,.870087,.873095,.8760701,.8790122,.8819213,.8847971,.8876396,.8904487,.8932243,.8959662,.8986745,.9013488,.9039893,.9065957,.909168,.911706,.9142098,.9166791,.9191139,.921514,.9238795,.9262102,.9285061,.930767,.9329928,.9351835,.937339,.9394592,.9415441,.9435935,.9456073,.9475856,.9495282,.951435,.953306,.9551412,.9569403,.9587035,.9604305,.9621214,.9637761,.9653944,.9669765,.9685221,.9700313,.9715039,.97294,.9743394,.9757021,.9770281,.9783174,.9795698,.9807853,.9819639,.9831055,.9842101,.9852776,.9863081,.9873014,.9882576,.9891765,.9900582,.9909026,.9917098,.9924795,.9932119,.993907,.9945646,.9951847,.9957674,.9963126,.9968203,.9972905,.9977231,.9981181,.9984756,.9987955,.9990777,.9993224,.9995294,.9996988,.9998306,.9999247,.9999812],C={sin:e=>_[e>>6],cos:e=>_[256+(e>>6)],deg:e=>182.04166666666666*(e>=0?e%360:360-Math.abs(e)%360)},E={scaling:function(e=0,t=0,r=0){return Object.freeze([e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1])},translation:function(e=0,t=0,r=0){return Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,e,t,r,1])},rotation:function(t=0,r=0,n=0){t=C.deg(t),r=C.deg(r),n=C.deg(n);const i=C.cos,a=C.sin,o=[1,0,0,0,0,i(t),-a(t),0,0,a(t),i(t),0,0,0,0,1],l=[i(r),0,a(r),0,0,1,0,0,-a(r),0,i(r),0,0,0,0,1],s=[i(n),-a(n),0,0,a(n),i(n),0,0,0,0,1,0,0,0,0,1],d=E.multiply(l,s),h=E.multiply(o,d);return e?.(16===h.length,"Expected a 4 x 4 matrix."),Object.freeze(h)},perspective:function(e=0,t=0,r=0,n=0){const i=Math.tan(e/2),a=r-n;return Object.freeze([1/(i*t),0,0,0,0,1/i,0,0,0,0,(-r-n)/a,1,0,0,2*n*(r/a),0])},ortho:function(e=0,t=0){return Object.freeze([e/2,0,0,0,0,-t/2,0,0,0,0,1,0,e/2-.5,t/2-.5,0,1])},multiply:function(t=[],r=[]){e?.(16===t.length&&16===r.length,"Expected 4 x 4 matrices.");let n=new Array(16);for(let e=0;e<4;e++)for(let i=0;i<4;i++)n[e+4*i]=t[e+0]*r[0+4*i]+t[e+4]*r[1+4*i]+t[e+8]*r[2+4*i]+t[e+12]*r[3+4*i];return Object.freeze(n)}};function W(t=[c()],r={}){return e?.(t instanceof Array,"Expected a list of ngons for creating an ngon mesh."),e?.(r instanceof Object,"Expected an object with transformation properties."),e?.(void 0!==W.defaultTransform?.rotation&&void 0!==W.defaultTransform?.translation&&void 0!==W.defaultTransform?.scaling,"The default transforms object for mesh() is missing required properties."),{ngons:t,rotation:(r={...W.defaultTransform,...r}).rotation,translation:r.translation,scale:r.scaling}}function D({renderState:e,mesh:t,cameraMatrix:r,perspectiveMatrix:n,screenSpaceMatrix:a}={}){const o={x:0,y:0,z:0},s=e.ngonCache,d=e.vertexCache,h=E.multiply(n,r),u=W.object_space_matrix(t);for(const r of t.ngons){if(!r.material.hasWireframe&&r.material.allowAlphaReject&&r.material.color.alpha<=0)continue;if(!r.material.isTwoSided&&(o.x=r.vertices[0].x-e.cameraPosition.x,o.y=r.vertices[0].y-e.cameraPosition.y,o.z=r.vertices[0].z-e.cameraPosition.z,l.dot(r.normal,o)>=0))continue;const t=s.ngons[s.count++];t.vertices.length=0;for(let n=0;n<r.vertices.length;n++){const i=r.vertices[n],a=t.vertices[n]=d.vertices[d.count++];a.x=i.x,a.y=i.y,a.z=i.z,a.u=i.u,a.v=i.v,a.w=i.w,a.shade=i.shade,(e.useVertexShader||"gouraud"===r.material.vertexShading)&&(t.vertexNormals[n]=l(r.vertexNormals[n].x,r.vertexNormals[n].y,r.vertexNormals[n].z))}if(t.material=r.material,t.normal.x=r.normal.x,t.normal.y=r.normal.y,t.normal.z=r.normal.z,t.isActive=!0,t.mipLevel=r.mipLevel,!t.material.isInScreenSpace){if(c.transform(t,u),e.useFragmentBuffer)for(let e=0;e<t.vertices.length;e++)t.vertices[e].worldX=t.vertices[e].x,t.vertices[e].worldY=t.vertices[e].y,t.vertices[e].worldZ=t.vertices[e].z;if(e.useVertexShader||"gouraud"===t.material.vertexShading)for(let e=0;e<t.vertices.length;e++)l.transform(t.vertexNormals[e],u),l.normalize(t.vertexNormals[e]);else l.transform(t.normal,u),l.normalize(t.normal);if("none"!==t.material.vertexShading&&I(t,e),e.useVertexShader){const r=[t,e.cameraPosition],n="ngon, cameraPos";switch(typeof e.modules.vertex_shader){case"function":e.modules.vertex_shader(...r);break;case"string":Function(n,`(${e.modules.vertex_shader})(${n})`)(...r);break;default:i("Unrecognized type of vertex shader function.")}}if(c.transform(t,h),c.clip_to_viewport(t),!t.vertices.length){s.count--;continue}c.transform(t,a),c.perspective_divide(t)}}for(let e=s.count;e<s.ngons.length;e++)s.ngons[e].isActive=!1}function I(e,t){const r=l();let n=e.material.ambientLightLevel;for(let t=0;t<e.vertices.length;t++)e.vertices[t].shade=e.material.ambientLightLevel;let a=0,o=0,s=0;if("flat"===e.material.vertexShading){for(const t of e.vertices)a+=t.x,o+=t.y,s+=t.z;a/=e.vertices.length,o/=e.vertices.length,s/=e.vertices.length}for(const d of t.lights)if("gouraud"===e.material.vertexShading)for(let t=0;t<e.vertices.length;t++){const n=e.vertices[t],i=Math.sqrt((n.x-d.position.x)*(n.x-d.position.x)+(n.y-d.position.y)*(n.y-d.position.y)+(n.z-d.position.z)*(n.z-d.position.z)),a=1/(1+d.attenuation*i);r.x=d.position.x-n.x,r.y=d.position.y-n.y,r.z=d.position.z-n.z,l.normalize(r);const o=Math.max(0,Math.min(1,l.dot(e.vertexNormals[t],r)));n.shade=Math.max(n.shade,Math.min(d.clip,o*a*d.intensity))}else if("flat"===e.material.vertexShading){const t=Math.sqrt((a-d.position.x)*(a-d.position.x)+(o-d.position.y)*(o-d.position.y)+(s-d.position.z)*(s-d.position.z)),i=1/(1+d.attenuation*t);r.x=d.position.x-a,r.y=d.position.y-o,r.z=d.position.z-s,l.normalize(r);const h=Math.max(0,Math.min(1,l.dot(e.normal,r)));n=Math.max(n,Math.min(d.clip,h*i*d.intensity))}else i("Unknown shading mode.");if("flat"===e.material.vertexShading)for(let t=0;t<e.vertices.length;t++)e.vertices[t].shade=n}function A(t,r){const n=null===t;let l,s,d;try{({surfaceWidth:l,surfaceHeight:s,canvasElement:t,renderContext:d}=n?function(e){return{surfaceWidth:e.offscreenRenderWidth,surfaceHeight:e.offscreenRenderHeight,renderContext:{createImageData:function(e,t){return new ImageData(e,t)}}}}(r):function(t,r){const n=r?.getContext("2d");e?.(r instanceof Element&&n,"Invalid canvas element."),t.usePalette&&(t.pixelBuffer.palette=t.palette);const i=a(r,t.renderScale),l=o(r,t.renderScale);return e?.(i>0&&l>0,"Failed to query the dimensions of the canvas."),r.setAttribute("width",i),r.setAttribute("height",l),{surfaceWidth:i,surfaceHeight:l,canvasElement:r,renderContext:n}}(r,t)),function(e,t,r,n){e.pixelBuffer.width==r&&e.pixelBuffer.height==n||(e.pixelBuffer=t.createImageData(r,n)),!e.useFragmentBuffer||e.fragmentBuffer.width==r&&e.fragmentBuffer.height==n||(e.fragmentBuffer.width=r,e.fragmentBuffer.height=n,e.fragmentBuffer.data=new Array(r*n).fill().map((e=>({})))),!e.useDepthBuffer||e.depthBuffer.width==r&&e.depthBuffer.height==n&&e.depthBuffer.data.length||(e.depthBuffer.width=r,e.depthBuffer.height=n,e.depthBuffer.data=new Array(e.depthBuffer.width*e.depthBuffer.height))}(r,d,l,s)}catch(e){return console.error(e),null}const u=E.multiply(E.rotation(r.cameraDirection.x,r.cameraDirection.y,r.cameraDirection.z),E.translation(-r.cameraPosition.x,-r.cameraPosition.y,-r.cameraPosition.z)),f=E.perspective(r.fov*(Math.PI/180),l/s,r.nearPlaneDistance,r.farPlaneDistance),p=E.ortho(l+1,s+1),g=Object.freeze({width:l,height:s,display_meshes:function(t=[]){if(r.modules.surface_wipe?.(r),function(t,r=[c()]){e?.(r instanceof Array,"Invalid arguments to n-gon cache initialization.");const n=t.vertexCache;let i=0;for(const e of r)for(const t of e.ngons)i+=t.vertices.length;if(!n||!n.vertices.length||n.vertices.length<i){const e=i-n.vertices.length;n.vertices.push(...new Array(e).fill().map((e=>h())))}n.count=0}(r,t),function(t,r=[c()]){e?.(r instanceof Array,"Invalid arguments to n-gon cache initialization.");const n=t.ngonCache,i=r.reduce(((e,t)=>e+t.ngons.length),0);if(!n||!n.ngons.length||n.ngons.length<i){const e=i-n.ngons.length;n.ngons.push(...new Array(e).fill().map((e=>c())))}n.count=0}(r,t),r.modules.transform_clip_light)for(const e of t)r.modules.transform_clip_light({renderState:r,mesh:e,cameraMatrix:u,perspectiveMatrix:f,screenSpaceMatrix:p});if(r.useDepthBuffer&&r.ngonCache.ngons.sort(((e,t)=>{const r=e.isActive?e.vertices.reduce(((e,t)=>e+t.z),0)/e.vertices.length:Number.MAX_VALUE,n=t.isActive?t.vertices.reduce(((e,t)=>e+t.z),0)/t.vertices.length:Number.MAX_VALUE;return r===n?0:r>n?1:-1})),function(e){for(let t=0;t<e.ngonCache.count;t++){const r=e.ngonCache.ngons[t];if(r.material.texture&&"affine"===r.material.textureMapping){let e=0==(r.material.texture.width&r.material.texture.width-1),t=0==(r.material.texture.height&r.material.texture.height-1);0===r.material.texture.width&&(e=!1),0===r.material.texture.height&&(t=!1),e&&t||(r.material.textureMapping="affine-npot")}}}(r),r.modules.rasterize?.(r),r.usePixelShader){const e={renderState:r,renderWidth:l,renderHeight:s,fragmentBuffer:r.fragmentBuffer.data,pixelBuffer:r.pixelBuffer.data,ngonCache:r.ngonCache.ngons,cameraPosition:r.cameraPosition},t=`{${Object.keys(e).join(",")}}`;switch(typeof r.modules.pixel_shader){case"function":r.modules.pixel_shader(e);break;case"string":Function(t,`(${r.modules.pixel_shader})(${t})`)(e);break;default:i("Unrecognized type of pixel shader function.")}}n||(r.useContextShader?r.modules.context_shader({context:d,image:r.pixelBuffer}):d.putImageData(r.pixelBuffer,0,0))},is_in_view:function(){if(n)return!0;const e=window.innerHeight,r=t.getBoundingClientRect();return r.top>-r.height&&r.top<e}});return g}function R(e="default"){return R[e]||(R[e]=L())}function L(){return{modules:{transform_clip_lighter:void 0,surface_wiper:void 0,rasterizer:void 0,vertex_shader:void 0,pixel_shader:void 0,context_shader:void 0,raster_shader:void 0},useDepthBuffer:!1,depthBuffer:{width:1,height:1,data:new Array(1),clearValue:1/0},usePalette:!1,palette:void 0,pixelBuffer:new ImageData(1,1),useFragmentBuffer:!1,fragmentBuffer:{width:1,height:1,data:new Array(1),clearValue:{ngonIdx:void 0,textureUScaled:void 0,textureVScaled:void 0,textureMipLevelIdx:void 0,worldX:void 0,worldY:void 0,worldZ:void 0,depth:void 0,shade:void 0,w:void 0}},usePixelShader:!1,pixel_shader:void 0,useVertexShader:!1,vertex_shader:void 0,useContextShader:!1,context_shader:void 0,offscreenRenderWidth:1,offscreenRenderHeight:1,renderScale:1,usePerspectiveInterpolation:!0,showGlobalWireframe:!1,nearPlaneDistance:1,farPlaneDistance:1,fov:45,cameraDirection:void 0,cameraPosition:void 0,allowWindowAlert:!1,ngonCache:{count:0,ngons:[]},vertexCache:{count:0,vertices:[]},lights:[]}}function N({target:t=null,scene:r=[W()],options:n={},pipeline:i={}}={}){const a={renderWidth:0,renderHeight:0,numNgonsRendered:0,totalRenderTimeMs:performance.now()},o=function(e={},t={}){const r=R(e.state);return r.useDepthBuffer=Boolean(e.useDepthBuffer),r.showGlobalWireframe=Boolean(e.globalWireframe),r.lights=e.lights,r.renderScale="number"==typeof e.resolution?e.resolution:1,r.offscreenRenderWidth=e.resolution.width,r.offscreenRenderHeight=e.resolution.height,r.nearPlaneDistance=e.nearPlane,r.farPlaneDistance=e.farPlane,r.fov=e.fov,r.cameraDirection=e.cameraDirection,r.cameraPosition=e.cameraPosition,r.usePerspectiveInterpolation=Boolean(e.usePerspectiveInterpolation),r.useFragmentBuffer=Boolean(e.useFragmentBuffer||r.usePixelShader&&r.pixel_shader?.toString().match(/{(.+)?}/)[1].includes("fragmentBuffer")),r.usePalette=Array.isArray(e.palette),r.palette=e.palette,r.modules.rasterize="function"==typeof t.rasterizer?t.rasterizer:null===t.rasterizer?null:S,r.modules.transform_clip_light="function"==typeof t.transformClipLighter?t.transformClipLighter:null===t.transformClipLighter?null:D,r.modules.surface_wipe="function"==typeof t.surfaceWiper?t.surfaceWiper:null===t.surfaceWiper?null:P,r.usePixelShader=Boolean(t.pixelShader),r.modules.pixel_shader="function"==typeof t.pixelShader?t.pixelShader:(t.pixelShader,null),r.useVertexShader=Boolean(t.vertexShader),r.modules.vertex_shader="function"==typeof t.vertexShader?t.vertexShader:(t.vertexShader,null),r.useContextShader=Boolean(t.contextShader),r.modules.context_shader="function"==typeof t.contextShader?t.contextShader:(t.contextShader,null),r.modules.raster_shader="function"==typeof t.rasterShader?t.rasterShader:void 0,r}(n=Object.freeze({...N.defaultOptions,...n}),i=Object.freeze({...N.defaultPipeline,...i}));"string"==typeof t&&(t=document.getElementById(t)),e?.(null===t||t instanceof HTMLCanvasElement,"Invalid canvas element for rendering into."),e?.(!o.usePalette||t instanceof HTMLPalettedCanvasElement,"For paletted rendering, the attribute is='paletted-canvas' must be present on the target <canvas>.");{const e=A(t,o);a.renderWidth=e.width,a.renderHeight=e.height,!e||n.hibernateWhenTargetNotVisible&&!e.is_in_view()||(e.display_meshes(r),a.numNgonsRendered=o.ngonCache.count)}return a.totalRenderTimeMs=performance.now()-a.totalRenderTimeMs,a}function j(e=l(0,0,0),t={}){return{position:e,...j.defaultSettings,...t}}function O(t={}){if(t={width:0,height:0,pixels:[],encoding:"none",channels:"rgba:8+8+8+8",needsFlip:!0,...t},e?.(Number.isInteger(t.width)&&Number.isInteger(t.height),"Expected texture width and height to be integer values."),e?.(t.width>=0&&t.height>=0,"Expected texture width and height to be no less than zero."),e?.(t.width<=32768&&t.height<=32768,"Expected texture width/height to be no more than 32768/32768."),"none"!==t.encoding)if("base64"===t.encoding){const r=atob(t.pixels);switch(t.pixels=[],t.channels){case"rgba:8+8+8+8":e?.(r.length===t.width*t.height*4,"Unexpected data length for a Base64-encoded texture; expected 4 bytes per pixel.");for(let e=0;e<t.width*t.height*4;e++)t.pixels.push(r.charCodeAt(e));break;case"rgba:5+5+5+1":e?.(r.length===t.width*t.height*2,"Unexpected data length for a Base64-encoded texture; expected 2 bytes per pixel.");for(let e=0;e<t.width*t.height*2;e+=2){const n=r.charCodeAt(e)|r.charCodeAt(e+1)<<8;t.pixels.push(8*(31&n)),t.pixels.push(8*(n>>5&31)),t.pixels.push(8*(n>>10&31)),t.pixels.push(255*(n>>15&1))}break;default:i("Unrecognized value for texture 'channels' attribute.")}}else"none"!==t.encoding&&i("Unknown texture data encoding '"+t.encoding+"'.");e?.(t.pixels.length===t.width*t.height*4,"The texture's pixel array size doesn't match its width and height.");const r=[];for(let e=0;e<t.height;e++)for(let n=0;n<t.width;n++){const i=4*(n+(t.needsFlip?t.height-e-1:e)*t.width);r.push({red:t.pixels[i+0],green:t.pixels[i+1],blue:t.pixels[i+2],alpha:t.pixels[i+3]})}const n=[];for(let i=0;;i++){const a=Math.max(1,Math.floor(t.width/Math.pow(2,i))),o=Math.max(1,Math.floor(t.height/Math.pow(2,i))),l=[];{const e=t.width/a,n=t.height/o;for(let i=0;i<o;i++)for(let o=0;o<a;o++){const s=o+i*a,d=Math.floor(o*e)+Math.floor(i*n)*t.width;l[s]=r[d]}}if(n.push({width:a,height:o,pixels:l}),1===a&&1===o){e?.(n.length>0,"Failed to generate mip levels for a texture.");break}}return{...t,pixels:r,mipLevels:n}}W.defaultTransform={translation:l(0,0,0),rotation:l(0,0,0),scaling:l(1,1,1)},W.object_space_matrix=function(e){const t=E.translation(e.translation.x,e.translation.y,e.translation.z),r=E.rotation(e.rotation.x,e.rotation.y,e.rotation.z),n=E.scaling(e.scale.x,e.scale.y,e.scale.z);return E.multiply(E.multiply(t,r),n)},R.default=L(),N.defaultOptions={cameraPosition:l(0,0,0),cameraDirection:l(0,0,0),state:"default",resolution:1,fov:43,nearPlane:1,farPlane:1e3,useDepthBuffer:!0,useFragmentBuffer:!1,usePerspectiveInterpolation:!0,globalWireframe:!1,hibernateWhenTargetNotVisible:!0,lights:[],palette:null},N.defaultPipeline={surfaceWipe:void 0,rasterize:void 0,transformClipLighter:void 0,pixelShader:null,vertexShader:null,contextShader:null,rasterShader:void 0},j.defaultSettings={intensity:100,clip:1,attenuation:1},O.deep_copy=function(e){const t=new Array(e.width*e.height*4);for(let r=0;r<e.width*e.height;r++)t[4*r+0]=e.pixels[r].red,t[4*r+1]=e.pixels[r].green,t[4*r+2]=e.pixels[r].blue,t[4*r+3]=e.pixels[r].alpha;return O({...e,pixels:t})},O.load=function(e){return new Promise(((t,r)=>{fetch(e).then((e=>e.json())).then((e=>{t(O(e))})).catch((t=>{i(`Failed to create a texture with data from file '${e}'. Error: '${t}'.`)}))}))};const X={version:{major:0,minor:5,patch:0,dev:!0},defaultPipeline:{rasterizer:S,surface_wiper:P,transform_clip_lighter:D},render:N,assert:e,$throw:i,lerp:t,bilinear_sample:function(e,r=.5,n=r){const i=t(e(0,0),e(0,1),n),a=t(e(1,0),e(1,1),n);return t(i,a,r)},log:function(e="Hello there."){console.log(e)},renderable_width_of:a,renderable_height_of:o,color:s,color_index:function(t=0){return e?.(t>=0,"The given color index is out of range."),Object.freeze({index:t})},state:R,light:j,material:d,matrix44:E,mesh:W,ngon:c,surface:A,texture:O,trig:C,vector:l,vertex:h}})();var i=self;for(var a in n)i[a]=n[a];n.__esModule&&Object.defineProperty(i,"__esModule",{value:!0})})();