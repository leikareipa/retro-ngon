(()=>{"use strict";var e={d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{Rngon:()=>Z});const r=void 0,n=void 0;function o(e,t,r){return e+r*(t-e)}function a(e=""){throw Error(e)}function i(e,t){return Math.floor(parseInt(window.getComputedStyle(e).getPropertyValue("width"))*t)}function l(e,t){return Math.floor(parseInt(window.getComputedStyle(e).getPropertyValue("height"))*t)}function s(e=0,t=0,n=0){r?.({x:e,y:t,z:n},s.schema.arguments);const o={$constructor:"Vector",x:e,y:t,z:n};return r?.(o,s.schema.interface),o}function d(e=0,t=0,o=0,a=255){r?.({red:e,green:t,blue:o,alpha:a},d.schema.arguments),n?.(e>=0&&e<=255&&t>=0&&t<=255&&o>=0&&o<=255&&a>=0&&a<=255,"One or more of the given color values are out of range.");const i=Object.freeze({$constructor:"Color",red:e,green:t,blue:o,alpha:a,unitRange:Object.freeze({red:e/255,green:t/255,blue:o/255,alpha:a/255})});return r?.(i,d.schema.interface),i}function c(e={}){const t={$constructor:"Material",...c.default,...e};return r?.(t,c.schema.interface),t}function u(e=0,t=0,n=0,o=0,a=0,i=1,l=1,s=e,d=t,c=n){r?.({x:e,y:t,z:n,u:o,v:a,w:i,shade:l,worldX:s,worldY:d,worldZ:c},u.schema.arguments);const h={$constructor:"Vertex",x:e,y:t,z:n,u:o,v:a,w:i,shade:l,worldX:s,worldY:d,worldZ:c};return r?.(h,u.schema.interface),h}function h(e=[u()],t=c(),n=s(0,1,0)){r?.({vertices:e,material:t,vertexNormals:n},h.schema.arguments),Object.assign(t,c(t)),Array.isArray(n)||(n=new Array(e.length).fill().map((e=>s(n.x,n.y,n.z))));const o=n.reduce(((e,t)=>(e.x+=t.x,e.y+=t.y,e.z+=t.z,e)),s(0,0,0));s.normalize(o);{const t=e.map((e=>e.u)).some((e=>e<0)),r=e.map((e=>e.v)).some((e=>e<0));if(t||r)for(const n of e)t&&0===n.u&&(n.u=-Number.EPSILON),r&&0===n.v&&(n.v=-Number.EPSILON)}const a={$constructor:"Ngon",vertices:e,vertexNormals:n,normal:o,material:t,mipLevel:0};return r?.(a,h.schema.interface),a}s.schema={interface:{where:"in the return value of vector()",properties:{$constructor:{value:"Vector"},x:["number"],y:["number"],z:["number"]}},arguments:{where:"in arguments passed to vector()",properties:{x:["number"],y:["number"],z:["number"]}}},s.transform=function(e,t=[]){n?.(16===t.length,"Expected a 4 x 4 matrix to transform the vector by.");const r=t[0]*e.x+t[4]*e.y+t[8]*e.z,o=t[1]*e.x+t[5]*e.y+t[9]*e.z,a=t[2]*e.x+t[6]*e.y+t[10]*e.z;e.x=r,e.y=o,e.z=a},s.normalize=function(e){const t=e.x*e.x+e.y*e.y+e.z*e.z;if(0!=t&&1!=t){const r=1/Math.sqrt(t);e.x*=r,e.y*=r,e.z*=r}},s.dot=function(e,t){return e.x*t.x+e.y*t.y+e.z*t.z},s.cross=function(e,t){const r=s();return r.x=e.y*t.z-e.z*t.y,r.y=e.z*t.x-e.x*t.z,r.z=e.x*t.y-e.y*t.x,r},s.invert=function(e){e.x*=-1,e.y*=-1,e.z*=-1},d.schema={arguments:{where:"in arguments passed to color()",properties:{red:["number"],green:["number"],blue:["number"],alpha:["number"]}},interface:{where:"in the return value of color()",properties:{$constructor:{value:"Color"},red:["number"],green:["number"],blue:["number"],alpha:["number"],unitRange:{subschema:{red:["number"],green:["number"],blue:["number"],alpha:["number"]}}}}},c.default={color:d(255,255,255,255),wireframeColor:d(0,0,0,255),texture:void 0,textureMapping:"ortho",textureFiltering:"none",uvWrapping:"repeat",vertexShading:"none",renderVertexShade:!0,ambientLightLevel:0,hasWireframe:!1,hasFill:!0,isTwoSided:!0,isInScreenSpace:!1,allowAlphaReject:!1,allowAlphaBlend:!1},c.schema={interface:{where:"in the return value of material()",allowAdditionalProperties:!0,properties:{$constructor:{value:"Material"},color:["Color"],wireframeColor:["Color"],texture:["undefined","null","Texture"],textureMapping:["string"],textureFiltering:["string"],uvWrapping:["string"],vertexShading:["string"],renderVertexShade:["boolean"],ambientLightLevel:["number"],hasWireframe:["boolean"],hasFill:["boolean"],isTwoSided:["boolean"],isInScreenSpace:["boolean"],allowAlphaReject:["boolean"],allowAlphaBlend:["boolean"]}}},u.schema={arguments:{where:"in arguments passed to vertex()",properties:{x:["number"],y:["number"],z:["number"],u:["number"],v:["number"],w:["number"],shade:["number"],worldX:["number"],worldY:["number"],worldZ:["number"]}},interface:{where:"in the return value of vertex()",properties:{$constructor:{value:"Vertex"},x:["number"],y:["number"],z:["number"],u:["number"],v:["number"],w:["number"],shade:["number"],worldX:["number"],worldY:["number"],worldZ:["number"]}}},u.transform=function(e,t=[]){n?.(16===t.length,"Expected a 4 x 4 matrix to transform the vertex by.");const r=t[0]*e.x+t[4]*e.y+t[8]*e.z+t[12]*e.w,o=t[1]*e.x+t[5]*e.y+t[9]*e.z+t[13]*e.w,a=t[2]*e.x+t[6]*e.y+t[10]*e.z+t[14]*e.w,i=t[3]*e.x+t[7]*e.y+t[11]*e.z+t[15]*e.w;e.x=r,e.y=o,e.z=a,e.w=i},u.perspective_divide=function(e){e.x/=e.w,e.y/=e.w},h.schema={arguments:{where:"in arguments passed to ngon()",properties:{vertices:[["Vertex"]],material:["Material","object"],vertexNormals:[["Vector"],"Vector"]}},interface:{where:"in the return value of ngon()",properties:{$constructor:{value:"Ngon"},vertices:[["Vertex"]],vertexNormals:[["Vector"]],normal:["Vector"],material:["Material"],mipLevel:["number"]}}},h.perspective_divide=function(e){for(const t of e.vertices)u.perspective_divide(t)},h.transform=function(e,t){for(const r of e.vertices)u.transform(r,t)};const f=["x","y","z"],m=[1,-1];h.clip_to_viewport=function(e){for(const t of f)for(const r of m){if(!e.vertices.length)break;if(1==e.vertices.length){if(e.vertices[0].x<=e.vertices[0].w&&-e.vertices[0].x<=e.vertices[0].w&&e.vertices[0].y<=e.vertices[0].w&&-e.vertices[0].y<=e.vertices[0].w&&e.vertices[0].z<=e.vertices[0].w&&-e.vertices[0].z<=e.vertices[0].w)break;e.vertices.length=0;break}let n=e.vertices[e.vertices.length-(2==e.vertices.length?2:1)],a=n[t]*r,i=a<=n.w,l=0,s=e.vertices.length;for(let d=0;d<s;d++){const c=e.vertices[d][t]*r,h=c<=e.vertices[d].w;if(h^i){const t=(n.w-a)/(n.w-a-(e.vertices[d].w-c));e.vertices[s+l++]=u(o(n.x,e.vertices[d].x,t),o(n.y,e.vertices[d].y,t),o(n.z,e.vertices[d].z,t),o(n.u,e.vertices[d].u,t),o(n.v,e.vertices[d].v,t),o(n.w,e.vertices[d].w,t),o(n.shade,e.vertices[d].shade,t),o(n.worldX,e.vertices[d].worldX,t),o(n.worldY,e.vertices[d].worldY,t),o(n.worldZ,e.vertices[d].worldZ,t))}h&&(e.vertices[s+l++]=e.vertices[d]),n=e.vertices[d],a=c,i=h}e.vertices.splice(0,s)}};const p={enabled:[[[.25,0],[.5,.75]],[[.75,.5],[0,.25]]],disabled:[[[0,0],[0,0]],[[0,0],[0,0]]]};function g({renderState:e,ngonIdx:t,leftEdges:r,rightEdges:n,numLeftEdges:o,numRightEdges:i,pixelBuffer32:l}){if(!o||!i)return!0;const s=e.ngonCache.ngons[t],d=e.useFragmentBuffer,c=e.fragments,u=e.fragmentBuffer.data,h=e.useDepthBuffer?e.depthBuffer.data:null,f=e.pixelBuffer,m=f.data,g=f.width,x=s.material,v=x.texture||null,w=v&&"dither"===x.textureFiltering?p.enabled:p.disabled;let b=null,y=0;if(v){const e=v.mipLevels.length;y=Math.max(0,Math.min(e-1,Math.round((e-1)*s.mipLevel))),b=v.mipLevels[y]}let M=0,z=0,S=r[M],B=n[z];const P=r[0].top,W=r[o-1].bottom;let A=P-1;for(;++A<W;){const e=Math.min(g,Math.max(0,Math.round(S.x))),t=Math.min(g,Math.max(0,Math.ceil(B.x))),o=t-e+1;if(o>0){const r=(B.depth-S.depth)/o;let n=S.depth-r;const i=(B.shade-S.shade)/o;let f=S.shade-i;const p=(B.u-S.u)/o;let y=S.u-p;const M=(B.v-S.v)/o;let z=S.v-M;const C=(B.invW-S.invW)/o;let V=S.invW-C;const L=(B.worldX-S.worldX)/o;let j=S.worldX-L;const E=(B.worldY-S.worldY)/o;let D=S.worldY-E;const N=(B.worldZ-S.worldZ)/o;let I=S.worldZ-N,X=e+A*g-1,R=e-1;for(;++R<t;){let t=0,g=0;n+=r,f+=i,y+=p,z+=M,V+=C,j+=L,D+=E,I+=N,X++;const S=n/V;if(h&&h[X]<=S)continue;let B=x.renderVertexShade?f:1,U=0,Y=0,Z=0;if(v){switch(x.textureMapping){case"affine":switch(t=y/V,g=z/V,x.uvWrapping){case"clamp":{const e=1-Number.EPSILON;t=t<0?e+t:t,g=g<0?e+g:g;const r=w[1&A][1&R];t+=r[0]/b.width,g+=r[1]/b.height,t=b.width*(t<0?0:t>e?e:t),g=b.height*(g<0?0:g>e?e:g);break}case"repeat":{const e=w[1&A][1&R];t+=e[0]/b.width,g+=e[1]/b.height,t=b.width*(t-Math.floor(t)),g=b.height*(g-Math.floor(g));const r=Math.abs(t),n=Math.abs(g),o=r-~~r,a=n-~~n;t=(t&b.width-1)+o,g=(g&b.height-1)+a;break}default:a("Unrecognized UV wrapping mode.")}break;case"affine-npot":{t=y/V,g=z/V;const e=1-Number.EPSILON;t=t<0?e+t:t,g=g<0?e+g:g;const r=w[1&A][1&R];t+=r[0]/b.width,g+=r[1]/b.height,t=b.width*(t<0?0:t>e?e:t),g=b.height*(g<0?0:g>e?e:g)}break;case"ortho":{const r=W-P,n=R-e+1,a=A-P+1,i=w[1&A][1&R];t+=i[0],g+=i[1],t=n*(b.width/o),g=a*(b.height/r),g=b.height-g;break}default:a("Unknown texture-mapping mode.")}const r=4*(~~t+~~g*b.width);if(x.allowAlphaReject&&255!==b.pixels[r+3])continue;if(x.allowAlphaBlend&&_.stipple(x.color.alpha,R,A))continue;U=b.pixels[r+0],Y=b.pixels[r+1],Z=b.pixels[r+2]}else{if(x.allowAlphaBlend&&_.stipple(x.color.alpha,R,A))continue;U=x.color.red*B,Y=x.color.green*B,Z=x.color.blue*B}if(U*=B*x.color.unitRange.red,Y*=B*x.color.unitRange.green,Z*=B*x.color.unitRange.blue,B>1){const e=4*X;m[e+0]=U,m[e+1]=Y,m[e+2]=Z,m[e+3]=255}else l[X]=(255<<24)+(Z<<16)+(Y<<8)+~~U;if(h&&(h[X]=S),d){const e=u[X];!c.ngon||(e.ngon=s),!c.textureUScaled||(e.textureUScaled=~~t),!c.textureVScaled||(e.textureVScaled=~~g),!c.shade||(e.shade=f),!c.worldX||(e.worldX=j/V),!c.worldY||(e.worldY=D/V),!c.worldZ||(e.worldZ=I/V)}}}S.x+=S.delta.x,S.depth+=S.delta.depth,S.shade+=S.delta.shade,S.u+=S.delta.u,S.v+=S.delta.v,S.invW+=S.delta.invW,S.worldX+=S.delta.worldX,S.worldY+=S.delta.worldY,S.worldZ+=S.delta.worldZ,B.x+=B.delta.x,B.depth+=B.delta.depth,B.shade+=B.delta.shade,B.u+=B.delta.u,B.v+=B.delta.v,B.invW+=B.delta.invW,B.worldX+=B.delta.worldX,B.worldY+=B.delta.worldY,B.worldZ+=B.delta.worldZ,A===S.bottom-1&&(S=r[++M]),A===B.bottom-1&&(B=n[++z])}return!0}function x({renderState:e,ngonIdx:t,leftEdges:r,rightEdges:n,numLeftEdges:o,numRightEdges:a,pixelBuffer32:i}){const l=e.ngonCache.ngons[t],s=e.useFragmentBuffer,d=e.fragments,c=e.fragmentBuffer.data,u=e.pixelBuffer,h=u.data,f=u.width,m=e.useDepthBuffer?e.depthBuffer.data:null,p=l.material;let g=0,x=0,v=r[g],w=n[x];if(!o||!a)return;const b=r[0].top,y=r[o-1].bottom;let M=b-1;for(;++M<y;){const e=Math.min(f,Math.max(0,Math.round(v.x))),t=Math.min(f,Math.max(0,Math.ceil(w.x))),o=t-e+1;if(o>0){const r=(w.depth-v.depth)/o;let n=v.depth-r;const a=(w.shade-v.shade)/o;let u=v.shade-a;const g=(w.invW-v.invW)/o;let x=v.invW-g,b=e+M*f-1,y=e-1;for(;++y<t;){n+=r,u+=a,x+=g,b++;const e=n/x;if(!(m[b]<=e)){const t=p.renderVertexShade?u:1,r=p.color.red*t,n=p.color.green*t,o=p.color.blue*t;if(t>1){const e=4*b;h[e+0]=r,h[e+1]=n,h[e+2]=o,h[e+3]=255}else i[b]=(255<<24)+(o<<16)+(n<<8)+~~r;if(m[b]=e,s){const e=c[b];!d.ngon||(e.ngon=l),!d.shade||(e.shade=u)}}}}v.x+=v.delta.x,v.depth+=v.delta.depth,v.shade+=v.delta.shade,v.invW+=v.delta.invW,w.x+=w.delta.x,w.depth+=w.delta.depth,w.shade+=w.delta.shade,w.invW+=w.delta.invW,M===v.bottom-1&&(v=r[++g]),M===w.bottom-1&&(w=n[++x])}return!0}function v({renderState:e,ngonIdx:t,leftEdges:r,rightEdges:n,numLeftEdges:o,numRightEdges:i,pixelBuffer32:l}){if(!o||!i)return!0;const s=e.ngonCache.ngons[t],d=e.useFragmentBuffer,c=e.fragments,u=e.fragmentBuffer.data,h=e.pixelBuffer,f=h.data,m=h.width,p=e.useDepthBuffer?e.depthBuffer.data:null,g=s.material,x=g.texture||null;let v=null,w=0;const b=x.mipLevels.length;w=Math.max(0,Math.min(b-1,Math.round((b-1)*s.mipLevel))),v=x.mipLevels[w];let y=0,M=0,z=r[y],S=n[M];const B=r[0].top,_=r[o-1].bottom;let P=B-1;for(;++P<_;){const e=Math.min(m,Math.max(0,Math.round(z.x))),t=Math.min(m,Math.max(0,Math.ceil(S.x))),o=t-e+1;if(o>0){const r=(S.depth-z.depth)/o;let n=z.depth-r;const i=(S.shade-z.shade)/o;let h=z.shade-i;const x=(S.u-z.u)/o;let w=z.u-x;const b=(S.v-z.v)/o;let y=z.v-b;const M=(S.invW-z.invW)/o;let B=z.invW-M,_=e+P*m-1,W=e-1;for(;++W<t;){n+=r,h+=i,w+=x,y+=b,B+=M,_++;const e=n/B;if(p[_]<=e)continue;let t=w/B,o=y/B;switch(g.uvWrapping){case"clamp":{const e=1-Number.EPSILON;t=t<0?e+t:t,o=o<0?e+o:o,t=v.width*(t<0?0:t>e?e:t),o=v.height*(o<0?0:o>e?e:o);break}case"repeat":t=v.width*(t-Math.floor(t)),o=v.height*(o-Math.floor(o)),t&=v.width-1,o&=v.height-1;break;default:a("Unrecognized UV wrapping mode.")}const m=4*(~~t+~~o*v.width);{const r=g.renderVertexShade?h:1,a=v.pixels[m+0]*r,i=v.pixels[m+1]*r,x=v.pixels[m+2]*r;if(r>1){const e=4*_;f[e+0]=a,f[e+1]=i,f[e+2]=x,f[e+3]=255}else l[_]=(255<<24)+(x<<16)+(i<<8)+~~a;if(p[_]=e,d){const e=u[_];!c.ngon||(e.ngon=s),!c.textureUScaled||(e.textureUScaled=~~t),!c.textureVScaled||(e.textureVScaled=~~o),!c.depth||(e.depth=n/B),!c.shade||(e.shade=h),!c.w||(e.w=1/B)}}}}z.x+=z.delta.x,z.depth+=z.delta.depth,z.shade+=z.delta.shade,z.u+=z.delta.u,z.v+=z.delta.v,z.invW+=z.delta.invW,S.x+=S.delta.x,S.depth+=S.delta.depth,S.shade+=S.delta.shade,S.u+=S.delta.u,S.v+=S.delta.v,S.invW+=S.delta.invW,P===z.bottom-1&&(z=r[++y]),P===S.bottom-1&&(S=n[++M])}return!0}function w({renderState:e,ngonIdx:t,leftEdges:r,rightEdges:n,numLeftEdges:o,numRightEdges:i,pixelBuffer32:l}){if(!o||!i)return!0;const s=e.ngonCache.ngons[t],d=e.useFragmentBuffer,c=e.fragments,u=e.fragmentBuffer.data,h=e.pixelBuffer,f=h.data,m=h.width,p=e.useDepthBuffer?e.depthBuffer.data:null,g=s.material,x=g.texture||null;let v=null,w=0;const b=x.mipLevels.length;w=Math.max(0,Math.min(b-1,Math.round((b-1)*s.mipLevel))),v=x.mipLevels[w];let y=0,M=0,z=r[y],S=n[M];const B=r[0].top,_=r[o-1].bottom;let P=B-1;for(;++P<_;){const e=Math.min(m,Math.max(0,Math.round(z.x))),t=Math.min(m,Math.max(0,Math.ceil(S.x))),o=t-e+1;if(o>0){const r=(S.depth-z.depth)/o;let n=z.depth-r;const i=(S.shade-z.shade)/o;let h=z.shade-i;const x=(S.u-z.u)/o;let w=z.u-x;const b=(S.v-z.v)/o;let y=z.v-b;const M=(S.invW-z.invW)/o;let B=z.invW-M,_=e+P*m-1,W=e-1;for(;++W<t;){n+=r,h+=i,w+=x,y+=b,B+=M,_++;const e=n/B;if(p[_]<=e)continue;let t=w/B,o=y/B;switch(g.uvWrapping){case"clamp":{const e=1-Number.EPSILON;t=t<0?e+t:t,o=o<0?e+o:o,t=v.width*(t<0?0:t>e?e:t),o=v.height*(o<0?0:o>e?e:o);break}case"repeat":{t=v.width*(t-Math.floor(t)),o=v.height*(o-Math.floor(o));const e=Math.abs(t),r=Math.abs(o),n=e-~~e,a=r-~~r;t=(t&v.width-1)+n,o=(o&v.height-1)+a;break}default:a("Unrecognized UV wrapping mode.")}const m=4*(~~t+~~o*v.width);{const r=g.renderVertexShade?h:1,n=v.pixels[m+0]*r*g.color.unitRange.red,a=v.pixels[m+1]*r*g.color.unitRange.green,i=v.pixels[m+2]*r*g.color.unitRange.blue;if(r>1){const e=4*_;f[e+0]=n,f[e+1]=a,f[e+2]=i,f[e+3]=255}else l[_]=(255<<24)+(i<<16)+(a<<8)+~~n;if(p[_]=e,d){const e=u[_];!c.ngon||(e.ngon=s),!c.textureUScaled||(e.textureUScaled=~~t),!c.textureVScaled||(e.textureVScaled=~~o),!c.shade||(e.shade=h)}}}}z.x+=z.delta.x,z.depth+=z.delta.depth,z.shade+=z.delta.shade,z.u+=z.delta.u,z.v+=z.delta.v,z.invW+=z.delta.invW,S.x+=S.delta.x,S.depth+=S.delta.depth,S.shade+=S.delta.shade,S.u+=S.delta.u,S.v+=S.delta.v,S.invW+=S.delta.invW,P===z.bottom-1&&(z=r[++y]),P===S.bottom-1&&(S=n[++M])}return!0}const b=500,y=new Array(b),M=new Array(b),z=new Array(b).fill().map((()=>({top:void 0,bottom:void 0,start:{x:void 0,depth:void 0,shade:void 0,u:void 0,v:void 0,invW:void 0,worldX:void 0,worldY:void 0,worldZ:void 0},delta:{}}))),S=new Array(b).fill().map((()=>({top:void 0,bottom:void 0,start:{x:void 0,depth:void 0,shade:void 0,u:void 0,v:void 0,invW:void 0,worldX:void 0,worldY:void 0,worldZ:void 0},delta:{}}))),B=(e,t)=>e.y===t.y?0:e.y<t.y?-1:1;function _(e){for(let t=0;t<e.ngonCache.count;t++){const r=e.ngonCache.ngons[t];switch(r.vertices.length){case 0:continue;case 1:_.point(e,r.vertices[0],r.material);break;case 2:_.line(e,r.vertices[0],r.vertices[1],r.material.color);break;default:_.polygon(e,r,t)}}}function P(e){e.pixelBuffer.data.fill(0),e.useDepthBuffer&&e.depthBuffer.clear()}_.polygon=function(e,t=h(),r=0){n?.(t.vertices.length>=3,"Polygons must have 3 or more vertices"),n?.(t.vertices.length<b,"Overflowing the vertex buffer");const a=e.usePerspectiveInterpolation,i=e.useFragmentBuffer,l=e.fragments,s=e.useDepthBuffer?e.depthBuffer.data:null,d=e.pixelBuffer.width,c=e.pixelBuffer.height,u=t.material,f=new Uint32Array(e.pixelBuffer.data.buffer);let m=0,p=0,P=0,W=0;if(function(){t.vertices.sort(B);const e=t.vertices[0],r=t.vertices[t.vertices.length-1];y[m++]=e,M[p++]=e;for(let n=1;n<t.vertices.length-1;n++){const a=o(e.x,r.x,(t.vertices[n].y-e.y)/(r.y-e.y));t.vertices[n].x>=a?M[p++]=t.vertices[n]:y[m++]=t.vertices[n]}y[m++]=r,M[p++]=r}(),function(){for(let e=1;e<m;e++)t(y[e-1],y[e],!0);for(let e=1;e<p;e++)t(M[e-1],M[e],!1);function t(t,r,n){const o=Math.min(c,Math.max(0,Math.floor(t.y))),l=Math.min(c,Math.max(0,Math.floor(r.y))),s=l-o;if(0===s)return;const h=a?t.w:1,f=a?r.w:1,m=Math.min(d,Math.max(0,Math.floor(t.x))),p=(Math.min(d,Math.max(0,Math.floor(r.x)))-m)/s,g=t.z/e.farPlaneDistance,x=g/h,v=(r.z/e.farPlaneDistance/f-g/h)/s,w=t.shade,b=(r.shade-t.shade)/s,y=u.texture?t.u:1,M=u.texture?1-t.v:1,B=y/h,_=((u.texture?r.u:1)/f-y/h)/s,A=M/h,C=((u.texture?1-r.v:1)/f-M/h)/s,V=1/h,L=(1/f-1/h)/s,j=n?z[P++]:S[W++];j.top=o,j.bottom=l,j.x=m,j.delta.x=p,j.depth=x,j.delta.depth=v,j.shade=w,j.delta.shade=b,j.u=B,j.delta.u=_,j.v=A,j.delta.v=C,j.invW=V,j.delta.invW=L,i&&(j.worldX=t.worldX/h,j.delta.worldX=(r.worldX/f-t.worldX/h)/s,j.worldY=t.worldY/h,j.delta.worldY=(r.worldY/f-t.worldY/h)/s,j.worldZ=t.worldZ/h,j.delta.worldZ=(r.worldZ/f-t.worldZ/h)/s)}}(),u.hasFill){const t={renderState:e,ngonIdx:r,leftEdges:z,rightEdges:S,numLeftEdges:P,numRightEdges:W,pixelBuffer32:f};if(!e.modules.raster_shader?.(t)){let e;e=!u.texture||!s||l.worldX||l.worldY||l.worldZ||u.allowAlphaReject||u.allowAlphaBlend||"affine"!==u.textureMapping||"dither"===u.textureFiltering?u.texture||!s||l.worldX||l.worldY||l.worldZ||u.allowAlphaReject||u.allowAlphaBlend?g:x:255===u.color.red&&255===u.color.green&&255===u.color.blue&&"none"===u.textureFiltering?v:w,e(t)}}if(e.showGlobalWireframe||u.hasWireframe){for(let t=1;t<m;t++)_.line(e,y[t-1],y[t],u.wireframeColor);for(let t=1;t<p;t++)_.line(e,M[t-1],M[t],u.wireframeColor)}},_.line=function(e,t=u(),r=u(),n=d(),o=!0){if(255!==n.alpha)return;const a=e.pixelBuffer.width,i=e.pixelBuffer.height;if(t.x<0&&r.x<0||t.x>=a&&r.y>=a||t.y<0&&r.y<0||t.y>=i&&r.y<i)return;const l=e.usePerspectiveInterpolation,s=e.farPlaneDistance,c=e.useFragmentBuffer,h=e.useDepthBuffer?e.depthBuffer.data:null,f=e.pixelBuffer.data,m=new Uint32Array(f.buffer),p=Math.floor(t.x),g=Math.floor(t.y),x=Math.floor(r.x),v=Math.ceil(r.y);let w=Math.ceil(Math.sqrt((x-p)*(x-p)+(v-g)*(v-g)));const b=l?t.w:1,y=l?r.w:1,M=t.z/s,z=(r.z/s/y-M/b)/w,S=(r.shade/y-t.shade/y)/w,B=(1/y-1/b)/w;let _,P,W,A,C,V,L=M/b,j=t.shade/b,E=1/b;c&&(_=t.worldX/b,P=t.worldY/b,W=t.worldZ/b,A=(r.worldX/y-t.worldX/b)/w,C=(r.worldY/y-t.worldY/b)/w,V=(r.worldZ/y-t.worldZ/b)/w);let D=p,N=g;const I=(x-p)/w,X=(v-g)/w;for(;w--;){const t=~~D,r=~~N;if(t>=0&&r>=0&&t<a&&r<i){const i=L/E,l=j/E,s=t+r*a;if(o||!h||h[s]>i){const t=n.red*l,r=n.green*l,a=n.blue*l;if(l>1){const e=4*s;f[e+0]=t,f[e+1]=r,f[e+2]=a,f[e+3]=255}else m[s]=(255<<24)+(a<<16)+(r<<8)+~~t;if(h&&!o&&(h[s]=i),c){const t=e.fragmentBuffer.data[s];t.textureUScaled=void 0,t.textureVScaled=void 0,t.shade=j,t.worldX=_,t.worldY=P,t.worldZ=W}}}D+=I,N+=X,L+=z,j+=S,E+=B,c&&(_+=A,P+=C,W+=V)}},_.point=function(e,t=u(),r=c()){if(255!=r.color.alpha)return;const n=e.useFragmentBuffer,o=e.useDepthBuffer?e.depthBuffer.data:null,a=e.pixelBuffer.data,i=new Uint32Array(a.buffer),l=e.pixelBuffer.width,s=e.pixelBuffer.height,d=Math.floor(t.x),h=Math.floor(t.y),f=d+h*l;if(d<0||h<0||d>=l||h>=s)return;const m=t.z/e.farPlaneDistance,p=r.renderVertexShade?t.shade:1,g=r.texture?r.texture.pixels[0]:r.color,x=g.red*p,v=g.green*p,w=g.blue*p;if(!(o&&o[f]<=m)){if(p>1){const e=4*f;a[e+0]=x,a[e+1]=v,a[e+2]=w,a[e+3]=255}else i[f]=(255<<24)+(w<<16)+(v<<8)+x;if(o&&(o[f]=m),n){const r=e.fragmentBuffer.data[f];r.textureUScaled=0,r.textureVScaled=0,r.shade=p,r.worldX=t.worldX,r.worldY=t.worldY,r.worldZ=t.worldZ}}},_.stipple=function(){const e=[{width:8,height:6,pixels:[0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]},{width:4,height:4,pixels:[0,1,0,1,1,1,1,1,1,0,1,0,1,1,1,1]},{width:2,height:2,pixels:[1,0,0,1]}];for(let t=e.length-2;t>=0;t--)e.push({width:e[t].width,height:e[t].height,pixels:e[t].pixels.map((e=>Number(!e)))});return function(t,r,n){if(t<=0)return!0;if(t>=255)return!1;{const o=Math.floor(t/(256/e.length)),a=e[o],i=r%a.width+n%a.height*a.width;if(a.pixels[i])return!0}return!1}}();const W=[0,.0061359,.0122715,.0184067,.0245412,.0306748,.0368072,.0429383,.0490677,.0551952,.0613207,.0674439,.0735646,.0796824,.0857973,.091909,.0980171,.1041216,.1102222,.1163186,.1224107,.1284981,.1345807,.1406582,.1467305,.1527972,.1588581,.1649131,.1709619,.1770042,.1830399,.1890687,.1950903,.2011046,.2071114,.2131103,.2191012,.2250839,.2310581,.2370236,.2429802,.2489276,.2548657,.2607941,.2667128,.2726214,.2785197,.2844075,.2902847,.2961509,.3020059,.3078496,.3136817,.319502,.3253103,.3311063,.3368899,.3426607,.3484187,.3541635,.359895,.365613,.3713172,.3770074,.3826834,.388345,.393992,.3996242,.4052413,.4108432,.4164296,.4220003,.4275551,.4330938,.4386162,.4441221,.4496113,.4550836,.4605387,.4659765,.4713967,.4767992,.4821838,.4875502,.4928982,.4982277,.5035384,.5088301,.5141027,.519356,.5245897,.5298036,.5349976,.5401715,.545325,.550458,.5555702,.5606616,.5657318,.5707807,.5758082,.580814,.5857979,.5907597,.5956993,.6006165,.605511,.6103828,.6152316,.6200572,.6248595,.6296382,.6343933,.6391244,.6438315,.6485144,.6531728,.6578067,.6624158,.6669999,.671559,.6760927,.680601,.6850837,.6895405,.6939715,.6983762,.7027547,.7071068,.7114322,.7157308,.7200025,.7242471,.7284644,.7326543,.7368166,.7409511,.7450578,.7491364,.7531868,.7572088,.7612024,.7651673,.7691033,.7730105,.7768885,.7807372,.7845566,.7883464,.7921066,.7958369,.7995373,.8032075,.8068476,.8104572,.8140363,.8175848,.8211025,.8245893,.828045,.8314696,.8348629,.8382247,.841555,.8448536,.8481203,.8513552,.854558,.8577286,.8608669,.8639729,.8670462,.870087,.873095,.8760701,.8790122,.8819213,.8847971,.8876396,.8904487,.8932243,.8959662,.8986745,.9013488,.9039893,.9065957,.909168,.911706,.9142098,.9166791,.9191139,.921514,.9238795,.9262102,.9285061,.930767,.9329928,.9351835,.937339,.9394592,.9415441,.9435935,.9456073,.9475856,.9495282,.951435,.953306,.9551412,.9569403,.9587035,.9604305,.9621214,.9637761,.9653944,.9669765,.9685221,.9700313,.9715039,.97294,.9743394,.9757021,.9770281,.9783174,.9795698,.9807853,.9819639,.9831055,.9842101,.9852776,.9863081,.9873014,.9882576,.9891765,.9900582,.9909026,.9917098,.9924795,.9932119,.993907,.9945646,.9951847,.9957674,.9963126,.9968203,.9972905,.9977231,.9981181,.9984756,.9987955,.9990777,.9993224,.9995294,.9996988,.9998306,.9999247,.9999812,1,.9999812,.9999247,.9998306,.9996988,.9995294,.9993224,.9990777,.9987955,.9984756,.9981181,.9977231,.9972905,.9968203,.9963126,.9957674,.9951847,.9945646,.993907,.9932119,.9924795,.9917098,.9909026,.9900582,.9891765,.9882576,.9873014,.9863081,.9852776,.9842101,.9831055,.9819639,.9807853,.9795698,.9783174,.9770281,.9757021,.9743394,.97294,.9715039,.9700313,.9685221,.9669765,.9653944,.9637761,.9621214,.9604305,.9587035,.9569403,.9551412,.953306,.951435,.9495282,.9475856,.9456073,.9435935,.9415441,.9394592,.937339,.9351835,.9329928,.930767,.9285061,.9262102,.9238795,.921514,.9191139,.9166791,.9142098,.911706,.909168,.9065957,.9039893,.9013488,.8986745,.8959662,.8932243,.8904487,.8876396,.8847971,.8819213,.8790122,.8760701,.873095,.870087,.8670462,.8639729,.8608669,.8577286,.854558,.8513552,.8481203,.8448536,.841555,.8382247,.8348629,.8314696,.828045,.8245893,.8211025,.8175848,.8140363,.8104572,.8068476,.8032075,.7995373,.7958369,.7921066,.7883464,.7845566,.7807372,.7768885,.7730105,.7691033,.7651673,.7612024,.7572088,.7531868,.7491364,.7450578,.7409511,.7368166,.7326543,.7284644,.7242471,.7200025,.7157308,.7114322,.7071068,.7027547,.6983762,.6939715,.6895405,.6850837,.680601,.6760927,.671559,.6669999,.6624158,.6578067,.6531728,.6485144,.6438315,.6391244,.6343933,.6296382,.6248595,.6200572,.6152316,.6103828,.605511,.6006165,.5956993,.5907597,.5857979,.580814,.5758082,.5707807,.5657318,.5606616,.5555702,.550458,.545325,.5401715,.5349976,.5298036,.5245897,.519356,.5141027,.5088301,.5035384,.4982277,.4928982,.4875502,.4821838,.4767992,.4713967,.4659765,.4605387,.4550836,.4496113,.4441221,.4386162,.4330938,.4275551,.4220003,.4164296,.4108432,.4052413,.3996242,.393992,.388345,.3826834,.3770074,.3713172,.365613,.359895,.3541635,.3484187,.3426607,.3368899,.3311063,.3253103,.319502,.3136817,.3078496,.3020059,.2961509,.2902847,.2844075,.2785197,.2726214,.2667128,.2607941,.2548657,.2489276,.2429802,.2370236,.2310581,.2250839,.2191012,.2131103,.2071114,.2011046,.1950903,.1890687,.1830399,.1770042,.1709619,.1649131,.1588581,.1527972,.1467305,.1406582,.1345807,.1284981,.1224107,.1163186,.1102222,.1041216,.0980171,.091909,.0857973,.0796824,.0735646,.0674439,.0613207,.0551952,.0490677,.0429383,.0368072,.0306748,.0245412,.0184067,.0122715,.0061359,0,-.0061359,-.0122715,-.0184067,-.0245412,-.0306748,-.0368072,-.0429383,-.0490677,-.0551952,-.0613207,-.0674439,-.0735646,-.0796824,-.0857973,-.091909,-.0980171,-.1041216,-.1102222,-.1163186,-.1224107,-.1284981,-.1345807,-.1406582,-.1467305,-.1527972,-.1588581,-.1649131,-.1709619,-.1770042,-.1830399,-.1890687,-.1950903,-.2011046,-.2071114,-.2131103,-.2191012,-.2250839,-.2310581,-.2370236,-.2429802,-.2489276,-.2548657,-.2607941,-.2667128,-.2726214,-.2785197,-.2844075,-.2902847,-.2961509,-.3020059,-.3078496,-.3136817,-.319502,-.3253103,-.3311063,-.3368899,-.3426607,-.3484187,-.3541635,-.359895,-.365613,-.3713172,-.3770074,-.3826834,-.388345,-.393992,-.3996242,-.4052413,-.4108432,-.4164296,-.4220003,-.4275551,-.4330938,-.4386162,-.4441221,-.4496113,-.4550836,-.4605387,-.4659765,-.4713967,-.4767992,-.4821838,-.4875502,-.4928982,-.4982277,-.5035384,-.5088301,-.5141027,-.519356,-.5245897,-.5298036,-.5349976,-.5401715,-.545325,-.550458,-.5555702,-.5606616,-.5657318,-.5707807,-.5758082,-.580814,-.5857979,-.5907597,-.5956993,-.6006165,-.605511,-.6103828,-.6152316,-.6200572,-.6248595,-.6296382,-.6343933,-.6391244,-.6438315,-.6485144,-.6531728,-.6578067,-.6624158,-.6669999,-.671559,-.6760927,-.680601,-.6850837,-.6895405,-.6939715,-.6983762,-.7027547,-.7071068,-.7114322,-.7157308,-.7200025,-.7242471,-.7284644,-.7326543,-.7368166,-.7409511,-.7450578,-.7491364,-.7531868,-.7572088,-.7612024,-.7651673,-.7691033,-.7730105,-.7768885,-.7807372,-.7845566,-.7883464,-.7921066,-.7958369,-.7995373,-.8032075,-.8068476,-.8104572,-.8140363,-.8175848,-.8211025,-.8245893,-.828045,-.8314696,-.8348629,-.8382247,-.841555,-.8448536,-.8481203,-.8513552,-.854558,-.8577286,-.8608669,-.8639729,-.8670462,-.870087,-.873095,-.8760701,-.8790122,-.8819213,-.8847971,-.8876396,-.8904487,-.8932243,-.8959662,-.8986745,-.9013488,-.9039893,-.9065957,-.909168,-.911706,-.9142098,-.9166791,-.9191139,-.921514,-.9238795,-.9262102,-.9285061,-.930767,-.9329928,-.9351835,-.937339,-.9394592,-.9415441,-.9435935,-.9456073,-.9475856,-.9495282,-.951435,-.953306,-.9551412,-.9569403,-.9587035,-.9604305,-.9621214,-.9637761,-.9653944,-.9669765,-.9685221,-.9700313,-.9715039,-.97294,-.9743394,-.9757021,-.9770281,-.9783174,-.9795698,-.9807853,-.9819639,-.9831055,-.9842101,-.9852776,-.9863081,-.9873014,-.9882576,-.9891765,-.9900582,-.9909026,-.9917098,-.9924795,-.9932119,-.993907,-.9945646,-.9951847,-.9957674,-.9963126,-.9968203,-.9972905,-.9977231,-.9981181,-.9984756,-.9987955,-.9990777,-.9993224,-.9995294,-.9996988,-.9998306,-.9999247,-.9999812,-1,-.9999812,-.9999247,-.9998306,-.9996988,-.9995294,-.9993224,-.9990777,-.9987955,-.9984756,-.9981181,-.9977231,-.9972905,-.9968203,-.9963126,-.9957674,-.9951847,-.9945646,-.993907,-.9932119,-.9924795,-.9917098,-.9909026,-.9900582,-.9891765,-.9882576,-.9873014,-.9863081,-.9852776,-.9842101,-.9831055,-.9819639,-.9807853,-.9795698,-.9783174,-.9770281,-.9757021,-.9743394,-.97294,-.9715039,-.9700313,-.9685221,-.9669765,-.9653944,-.9637761,-.9621214,-.9604305,-.9587035,-.9569403,-.9551412,-.953306,-.951435,-.9495282,-.9475856,-.9456073,-.9435935,-.9415441,-.9394592,-.937339,-.9351835,-.9329928,-.930767,-.9285061,-.9262102,-.9238795,-.921514,-.9191139,-.9166791,-.9142098,-.911706,-.909168,-.9065957,-.9039893,-.9013488,-.8986745,-.8959662,-.8932243,-.8904487,-.8876396,-.8847971,-.8819213,-.8790122,-.8760701,-.873095,-.870087,-.8670462,-.8639729,-.8608669,-.8577286,-.854558,-.8513552,-.8481203,-.8448536,-.841555,-.8382247,-.8348629,-.8314696,-.828045,-.8245893,-.8211025,-.8175848,-.8140363,-.8104572,-.8068476,-.8032075,-.7995373,-.7958369,-.7921066,-.7883464,-.7845566,-.7807372,-.7768885,-.7730105,-.7691033,-.7651673,-.7612024,-.7572088,-.7531868,-.7491364,-.7450578,-.7409511,-.7368166,-.7326543,-.7284644,-.7242471,-.7200025,-.7157308,-.7114322,-.7071068,-.7027547,-.6983762,-.6939715,-.6895405,-.6850837,-.680601,-.6760927,-.671559,-.6669999,-.6624158,-.6578067,-.6531728,-.6485144,-.6438315,-.6391244,-.6343933,-.6296382,-.6248595,-.6200572,-.6152316,-.6103828,-.605511,-.6006165,-.5956993,-.5907597,-.5857979,-.580814,-.5758082,-.5707807,-.5657318,-.5606616,-.5555702,-.550458,-.545325,-.5401715,-.5349976,-.5298036,-.5245897,-.519356,-.5141027,-.5088301,-.5035384,-.4982277,-.4928982,-.4875502,-.4821838,-.4767992,-.4713967,-.4659765,-.4605387,-.4550836,-.4496113,-.4441221,-.4386162,-.4330938,-.4275551,-.4220003,-.4164296,-.4108432,-.4052413,-.3996242,-.393992,-.388345,-.3826834,-.3770074,-.3713172,-.365613,-.359895,-.3541635,-.3484187,-.3426607,-.3368899,-.3311063,-.3253103,-.319502,-.3136817,-.3078496,-.3020059,-.2961509,-.2902847,-.2844075,-.2785197,-.2726214,-.2667128,-.2607941,-.2548657,-.2489276,-.2429802,-.2370236,-.2310581,-.2250839,-.2191012,-.2131103,-.2071114,-.2011046,-.1950903,-.1890687,-.1830399,-.1770042,-.1709619,-.1649131,-.1588581,-.1527972,-.1467305,-.1406582,-.1345807,-.1284981,-.1224107,-.1163186,-.1102222,-.1041216,-.0980171,-.091909,-.0857973,-.0796824,-.0735646,-.0674439,-.0613207,-.0551952,-.0490677,-.0429383,-.0368072,-.0306748,-.0245412,-.0184067,-.0122715,-.0061359,-0,.0061359,.0122715,.0184067,.0245412,.0306748,.0368072,.0429383,.0490677,.0551952,.0613207,.0674439,.0735646,.0796824,.0857973,.091909,.0980171,.1041216,.1102222,.1163186,.1224107,.1284981,.1345807,.1406582,.1467305,.1527972,.1588581,.1649131,.1709619,.1770042,.1830399,.1890687,.1950903,.2011046,.2071114,.2131103,.2191012,.2250839,.2310581,.2370236,.2429802,.2489276,.2548657,.2607941,.2667128,.2726214,.2785197,.2844075,.2902847,.2961509,.3020059,.3078496,.3136817,.319502,.3253103,.3311063,.3368899,.3426607,.3484187,.3541635,.359895,.365613,.3713172,.3770074,.3826834,.388345,.393992,.3996242,.4052413,.4108432,.4164296,.4220003,.4275551,.4330938,.4386162,.4441221,.4496113,.4550836,.4605387,.4659765,.4713967,.4767992,.4821838,.4875502,.4928982,.4982277,.5035384,.5088301,.5141027,.519356,.5245897,.5298036,.5349976,.5401715,.545325,.550458,.5555702,.5606616,.5657318,.5707807,.5758082,.580814,.5857979,.5907597,.5956993,.6006165,.605511,.6103828,.6152316,.6200572,.6248595,.6296382,.6343933,.6391244,.6438315,.6485144,.6531728,.6578067,.6624158,.6669999,.671559,.6760927,.680601,.6850837,.6895405,.6939715,.6983762,.7027547,.7071068,.7114322,.7157308,.7200025,.7242471,.7284644,.7326543,.7368166,.7409511,.7450578,.7491364,.7531868,.7572088,.7612024,.7651673,.7691033,.7730105,.7768885,.7807372,.7845566,.7883464,.7921066,.7958369,.7995373,.8032075,.8068476,.8104572,.8140363,.8175848,.8211025,.8245893,.828045,.8314696,.8348629,.8382247,.841555,.8448536,.8481203,.8513552,.854558,.8577286,.8608669,.8639729,.8670462,.870087,.873095,.8760701,.8790122,.8819213,.8847971,.8876396,.8904487,.8932243,.8959662,.8986745,.9013488,.9039893,.9065957,.909168,.911706,.9142098,.9166791,.9191139,.921514,.9238795,.9262102,.9285061,.930767,.9329928,.9351835,.937339,.9394592,.9415441,.9435935,.9456073,.9475856,.9495282,.951435,.953306,.9551412,.9569403,.9587035,.9604305,.9621214,.9637761,.9653944,.9669765,.9685221,.9700313,.9715039,.97294,.9743394,.9757021,.9770281,.9783174,.9795698,.9807853,.9819639,.9831055,.9842101,.9852776,.9863081,.9873014,.9882576,.9891765,.9900582,.9909026,.9917098,.9924795,.9932119,.993907,.9945646,.9951847,.9957674,.9963126,.9968203,.9972905,.9977231,.9981181,.9984756,.9987955,.9990777,.9993224,.9995294,.9996988,.9998306,.9999247,.9999812],A={sin:e=>W[e>>6],cos:e=>W[256+(e>>6)],deg:e=>182.04166666666666*(e>=0?e%360:360-Math.abs(e)%360)},C={scaling:function(e=0,t=0,r=0){return Object.freeze([e,0,0,0,0,t,0,0,0,0,r,0,0,0,0,1])},translation:function(e=0,t=0,r=0){return Object.freeze([1,0,0,0,0,1,0,0,0,0,1,0,e,t,r,1])},rotation:function(e=0,t=0,r=0){e=A.deg(e),t=A.deg(t),r=A.deg(r);const o=A.cos,a=A.sin,i=[1,0,0,0,0,o(e),-a(e),0,0,a(e),o(e),0,0,0,0,1],l=[o(t),0,a(t),0,0,1,0,0,-a(t),0,o(t),0,0,0,0,1],s=[o(r),-a(r),0,0,a(r),o(r),0,0,0,0,1,0,0,0,0,1],d=C.multiply(l,s),c=C.multiply(i,d);return n?.(16===c.length,"Expected a 4 x 4 matrix."),Object.freeze(c)},perspective:function(e=0,t=0,r=0,n=0){const o=Math.tan(e/2),a=r-n;return Object.freeze([1/(o*t),0,0,0,0,1/o,0,0,0,0,(-r-n)/a,1,0,0,2*n*(r/a),0])},ortho:function(e=0,t=0){return Object.freeze([e/2,0,0,0,0,-t/2,0,0,0,0,1,0,e/2-.5,t/2-.5,0,1])},multiply:function(e=[],t=[]){n?.(16===e.length&&16===t.length,"Expected 4 x 4 matrices.");let r=new Array(16);for(let n=0;n<4;n++)for(let o=0;o<4;o++)r[n+4*o]=e[n+0]*t[0+4*o]+e[n+4]*t[1+4*o]+e[n+8]*t[2+4*o]+e[n+12]*t[3+4*o];return Object.freeze(r)}};function V(e=[h()],t={}){r?.({ngons:e,transform:t},V.schema.arguments);const n={$constructor:"Mesh",ngons:e,rotation:(t={...V.defaultTransform,...t}).rotation,translation:t.translation,scale:t.scaling};return r?.(n,V.schema.interface),n}function L({renderState:e,mesh:t,cameraMatrix:r,perspectiveMatrix:n,screenSpaceMatrix:o}={}){const i={x:0,y:0,z:0},l=e.ngonCache,d=e.vertexCache,c=C.multiply(n,r),u=V.object_space_matrix(t);for(const r of t.ngons){if(!r.material.hasWireframe&&r.material.allowAlphaReject&&r.material.color.alpha<=0)continue;if(!r.material.isTwoSided&&(i.x=r.vertices[0].x-e.cameraPosition.x,i.y=r.vertices[0].y-e.cameraPosition.y,i.z=r.vertices[0].z-e.cameraPosition.z,s.dot(r.normal,i)>=0))continue;const t=l.ngons[l.count++];t.vertices.length=0;for(let n=0;n<r.vertices.length;n++){const o=r.vertices[n],a=t.vertices[n]=d.vertices[d.count++];a.x=o.x,a.y=o.y,a.z=o.z,a.u=o.u,a.v=o.v,a.w=o.w,a.shade=o.shade,(e.useVertexShader||"gouraud"===r.material.vertexShading)&&(t.vertexNormals[n]=s(r.vertexNormals[n].x,r.vertexNormals[n].y,r.vertexNormals[n].z))}if(t.material=r.material,t.normal.x=r.normal.x,t.normal.y=r.normal.y,t.normal.z=r.normal.z,t.isActive=!0,t.mipLevel=r.mipLevel,!t.material.isInScreenSpace){if(h.transform(t,u),e.useFragmentBuffer)for(let e=0;e<t.vertices.length;e++)t.vertices[e].worldX=t.vertices[e].x,t.vertices[e].worldY=t.vertices[e].y,t.vertices[e].worldZ=t.vertices[e].z;if(e.useVertexShader||"gouraud"===t.material.vertexShading)for(let e=0;e<t.vertices.length;e++)s.transform(t.vertexNormals[e],u),s.normalize(t.vertexNormals[e]);else s.transform(t.normal,u),s.normalize(t.normal);if("none"!==t.material.vertexShading&&j(t,e),e.useVertexShader){const r=[t,e.cameraPosition],n="ngon, cameraPos";switch(typeof e.modules.vertex_shader){case"function":e.modules.vertex_shader(...r);break;case"string":Function(n,`(${e.modules.vertex_shader})(${n})`)(...r);break;default:a("Unrecognized type of vertex shader function.")}}if(h.transform(t,c),h.clip_to_viewport(t),!t.vertices.length){l.count--;continue}h.transform(t,o),h.perspective_divide(t)}}for(let e=l.count;e<l.ngons.length;e++)l.ngons[e].isActive=!1}function j(e,t){const r=s();let n=e.material.ambientLightLevel;for(let t=0;t<e.vertices.length;t++)e.vertices[t].shade=e.material.ambientLightLevel;let o=0,i=0,l=0;if("flat"===e.material.vertexShading){for(const t of e.vertices)o+=t.x,i+=t.y,l+=t.z;o/=e.vertices.length,i/=e.vertices.length,l/=e.vertices.length}for(const d of t.lights)if("gouraud"===e.material.vertexShading)for(let t=0;t<e.vertices.length;t++){const n=e.vertices[t],o=Math.sqrt((n.x-d.position.x)*(n.x-d.position.x)+(n.y-d.position.y)*(n.y-d.position.y)+(n.z-d.position.z)*(n.z-d.position.z)),a=1/(1+d.attenuation*o);r.x=d.position.x-n.x,r.y=d.position.y-n.y,r.z=d.position.z-n.z,s.normalize(r);const i=Math.max(0,Math.min(1,s.dot(e.vertexNormals[t],r)));n.shade=Math.max(n.shade,Math.min(d.clip,i*a*d.intensity))}else if("flat"===e.material.vertexShading){const t=Math.sqrt((o-d.position.x)*(o-d.position.x)+(i-d.position.y)*(i-d.position.y)+(l-d.position.z)*(l-d.position.z)),a=1/(1+d.attenuation*t);r.x=d.position.x-o,r.y=d.position.y-i,r.z=d.position.z-l,s.normalize(r);const c=Math.max(0,Math.min(1,s.dot(e.normal,r)));n=Math.max(n,Math.min(d.clip,c*a*d.intensity))}else a("Unknown shading mode.");if("flat"===e.material.vertexShading)for(let t=0;t<e.vertices.length;t++)e.vertices[t].shade=n}function E(e,t){const r=null===e;let o,s,d;try{({surfaceWidth:o,surfaceHeight:s,canvasElement:e,renderContext:d}=r?function(e){return{surfaceWidth:e.offscreenRenderWidth,surfaceHeight:e.offscreenRenderHeight,renderContext:{createImageData:function(e,t){return new ImageData(e,t)}}}}(t):function(e,t){const r=t?.getContext("2d");n?.(t instanceof Element&&r,"Invalid canvas element.");const o=i(t,e.renderScale),a=l(t,e.renderScale);return n?.(o>0&&a>0,"Failed to query the dimensions of the canvas."),t.setAttribute("width",o),t.setAttribute("height",a),{surfaceWidth:o,surfaceHeight:a,canvasElement:t,renderContext:r}}(t,e)),function(e,t,r,n){e.pixelBuffer.width==r&&e.pixelBuffer.height==n||(e.pixelBuffer=t.createImageData(r,n)),!e.useFragmentBuffer||e.fragmentBuffer.width==r&&e.fragmentBuffer.height==n||e.fragmentBuffer.resize(r,n),!e.useDepthBuffer||e.depthBuffer.width==r&&e.depthBuffer.height==n&&e.depthBuffer.data.length||e.depthBuffer.resize(r,n)}(t,d,o,s)}catch(e){return console.error(e),null}const c=C.multiply(C.rotation(t.cameraDirection.x,t.cameraDirection.y,t.cameraDirection.z),C.translation(-t.cameraPosition.x,-t.cameraPosition.y,-t.cameraPosition.z)),f=C.perspective(t.fov*(Math.PI/180),o/s,t.nearPlaneDistance,t.farPlaneDistance),m=C.ortho(o+1,s+1),p=Object.freeze({width:o,height:s,display_meshes:function(e=[]){if(t.modules.surface_wiper?.(t),function(e,t=[h()]){n?.(t instanceof Array,"Invalid arguments to n-gon cache initialization.");const r=e.vertexCache;let o=0;for(const e of t)for(const t of e.ngons)o+=t.vertices.length;if(!r||!r.vertices.length||r.vertices.length<o){const e=o-r.vertices.length;r.vertices.push(...new Array(e).fill().map((e=>u())))}r.count=0}(t,e),function(e,t=[h()]){n?.(t instanceof Array,"Invalid arguments to n-gon cache initialization.");const r=e.ngonCache,o=t.reduce(((e,t)=>e+t.ngons.length),0);if(!r||!r.ngons.length||r.ngons.length<o){const e=o-r.ngons.length;r.ngons.push(...new Array(e).fill().map((e=>h())))}r.count=0}(t,e),t.modules.transform_clip_lighter)for(const r of e)t.modules.transform_clip_lighter({renderState:t,mesh:r,cameraMatrix:c,perspectiveMatrix:f,screenSpaceMatrix:m});if(t.useDepthBuffer&&t.ngonCache.ngons.sort(((e,t)=>{const r=e.isActive?e.vertices.reduce(((e,t)=>e+t.z),0)/e.vertices.length:Number.MAX_VALUE,n=t.isActive?t.vertices.reduce(((e,t)=>e+t.z),0)/t.vertices.length:Number.MAX_VALUE;return r===n?0:r>n?1:-1})),function(e){for(let t=0;t<e.ngonCache.count;t++){const r=e.ngonCache.ngons[t];if(r.material.texture&&"affine"===r.material.textureMapping){let e=0==(r.material.texture.width&r.material.texture.width-1),t=0==(r.material.texture.height&r.material.texture.height-1);0===r.material.texture.width&&(e=!1),0===r.material.texture.height&&(t=!1),e&&t||(r.material.textureMapping="affine-npot")}}}(t),t.modules.rasterizer?.(t),t.usePixelShader){const e={renderState:t,renderWidth:o,renderHeight:s,fragmentBuffer:t.fragmentBuffer.data,pixelBuffer:t.pixelBuffer.data,depthBuffer:t.depthBuffer.data,ngonCache:t.ngonCache.ngons,cameraPosition:t.cameraPosition},r=`{${Object.keys(e).join(",")}}`;switch(typeof t.modules.pixel_shader){case"function":t.modules.pixel_shader(e);break;case"string":Function(r,`(${t.modules.pixel_shader})(${r})`)(e);break;default:a("Unrecognized type of pixel shader function.")}}r||(t.useContextShader?t.modules.context_shader({context:d,image:t.pixelBuffer}):d.putImageData(t.pixelBuffer,0,0))},is_in_view:function(){if(r)return!0;const t=window.innerHeight,n=e.getBoundingClientRect();return n.top>-n.height&&n.top<t}});return p}function D(e="default"){return D[e]||(D[e]=N())}function N(){return{modules:{transform_clip_lighter:void 0,surface_wiper:void 0,rasterizer:void 0,vertex_shader:void 0,pixel_shader:void 0,context_shader:void 0,raster_shader:void 0},pixelBuffer:new ImageData(1,1),useDepthBuffer:!1,depthBuffer:{width:0,height:0,data:void 0,resize(e,t){this.width=e,this.height=t,this.data=new Float64Array(e*t)},clear(){this.data.fill(1)}},useFragmentBuffer:!1,fragmentBuffer:{width:0,height:0,data:void 0,resize(e,t){this.width=e,this.height=t,this.data=new Array(e*t).fill().map((e=>({})))}},fragments:{ngon:!0,textureUScaled:!0,textureVScaled:!0,shade:!0,worldX:!0,worldY:!0,worldZ:!0},usePixelShader:!1,pixel_shader:void 0,useVertexShader:!1,vertex_shader:void 0,useContextShader:!1,context_shader:void 0,offscreenRenderWidth:1,offscreenRenderHeight:1,renderScale:1,usePerspectiveInterpolation:!0,showGlobalWireframe:!1,nearPlaneDistance:1,farPlaneDistance:1,fov:45,cameraDirection:void 0,cameraPosition:void 0,allowWindowAlert:!1,ngonCache:{count:0,ngons:[]},vertexCache:{count:0,vertices:[]},lights:[]}}function I({target:e=null,scene:t,options:o={},pipeline:a={}}={}){r?.({target:e,scene:t,options:o,pipeline:a},I.schema.arguments);const i={renderWidth:0,renderHeight:0,numNgonsRendered:0,totalRenderTimeMs:performance.now()};o=Object.freeze({...I.defaultOptions,...o}),a=Object.freeze({...I.defaultPipeline,...a}),r?.(o,I.schema.options),r?.(a,I.schema.pipeline);const l=function(e={},t={}){const r=D(e.state);if(r.useDepthBuffer=Boolean(e.useDepthBuffer),r.showGlobalWireframe=Boolean(e.globalWireframe),r.lights=e.lights,r.renderScale="number"==typeof e.resolution?e.resolution:1,r.offscreenRenderWidth=e.resolution.width,r.offscreenRenderHeight=e.resolution.height,r.nearPlaneDistance=e.nearPlane,r.farPlaneDistance=e.farPlane,r.fov=e.fov,r.cameraDirection=e.cameraDirection,r.cameraPosition=e.cameraPosition,r.usePerspectiveInterpolation=Boolean(e.usePerspectiveInterpolation),r.useFragmentBuffer=Boolean(e.useFragmentBuffer||r.usePixelShader&&r.pixel_shader?.toString().match(/{(.+)?}/)[1].includes("fragmentBuffer")),"object"==typeof e.fragments)for(const t of Object.keys(r.fragments))r.fragments[t]=e.fragments[t]??!1;else for(const e of Object.keys(r.fragments))r.fragments[e]=r.useFragmentBuffer;return r.modules.rasterizer="function"==typeof t.rasterizer?t.rasterizer:null===t.rasterizer?null:_,r.modules.transform_clip_lighter="function"==typeof t.transformClipLighter?t.transformClipLighter:null===t.transformClipLighter?null:L,r.modules.surface_wiper="function"==typeof t.surfaceWiper?t.surfaceWiper:null===t.surfaceWiper?null:P,r.usePixelShader=Boolean(t.pixelShader),r.modules.pixel_shader="function"==typeof t.pixelShader?t.pixelShader:(t.pixelShader,null),r.useVertexShader=Boolean(t.vertexShader),r.modules.vertex_shader="function"==typeof t.vertexShader?t.vertexShader:(t.vertexShader,null),r.useContextShader=Boolean(t.contextShader),r.modules.context_shader="function"==typeof t.contextShader?t.contextShader:(t.contextShader,null),r.modules.raster_shader="function"==typeof t.rasterShader?t.rasterShader:void 0,r}(o,a);"string"==typeof e&&(e=document.getElementById(e)),n?.(null===e||e instanceof HTMLCanvasElement,"Invalid canvas element for rendering into.");{const r=E(e,l);i.renderWidth=r.width,i.renderHeight=r.height,!r||o.hibernateWhenTargetNotVisible&&!r.is_in_view()||(r.display_meshes(t),i.numNgonsRendered=l.ngonCache.count)}return i.totalRenderTimeMs=performance.now()-i.totalRenderTimeMs,i}function X(e=s(0,0,0),t={}){return{$constructor:"Light",position:e,...X.defaultSettings,...t}}V.defaultTransform={translation:s(0,0,0),rotation:s(0,0,0),scaling:s(1,1,1)},V.schema={interface:{where:"in the return value of mesh()",allowAdditionalProperties:!0,properties:{$constructor:{value:"Mesh"},ngons:[["Ngon"]],rotation:["Vector"],translation:["Vector"],scale:["Vector"]}},arguments:{where:"in arguments passed to mesh()",properties:{ngons:[["Ngon"]],transform:["object"]}}},V.object_space_matrix=function(e){const t=C.translation(e.translation.x,e.translation.y,e.translation.z),r=C.rotation(e.rotation.x,e.rotation.y,e.rotation.z),n=C.scaling(e.scale.x,e.scale.y,e.scale.z);return C.multiply(C.multiply(t,r),n)},D.default=N(),I.defaultOptions={cameraPosition:s(0,0,0),cameraDirection:s(0,0,0),state:"default",resolution:1,fov:43,nearPlane:1,farPlane:1e3,useDepthBuffer:!0,useFragmentBuffer:!1,fragments:void 0,usePerspectiveInterpolation:!0,globalWireframe:!1,hibernateWhenTargetNotVisible:!0,lights:[]},I.defaultPipeline={surfaceWiper:void 0,rasterizer:void 0,transformClipLighter:void 0,pixelShader:null,vertexShader:null,contextShader:null,rasterShader:void 0},I.schema={arguments:{where:"in arguments passed to render()",properties:{target:["HTMLCanvasElement","string","null"],scene:[["Mesh"]],options:["object"],pipeline:["object"]}},options:{where:"in render({options})",properties:{cameraPosition:["Vector"],cameraDirection:["Vector"],state:["string","number"],resolution:["number","object"],fov:["number"],nearPlane:["number"],farPlane:["number"],useDepthBuffer:["boolean"],useFragmentBuffer:["boolean"],fragments:["object","undefined"],usePerspectiveInterpolation:["boolean"],globalWireframe:["boolean"],hibernateWhenTargetNotVisible:["boolean"],lights:[["Light"]]}},pipeline:{where:"in render({pipeline})",properties:{surfaceWiper:["undefined","null","function"],rasterizer:["undefined","null","function"],transformClipLighter:["undefined","null","function"],pixelShader:["undefined","null","function"],vertexShader:["undefined","null","function"],contextShader:["undefined","null","function"],rasterShader:["undefined","null","function"]}}},X.defaultSettings={intensity:100,clip:1,attenuation:1};const R=4;function U(e={}){e={width:1,height:1,pixels:[255,255,255,255],encoding:"none",channels:"rgba:8+8+8+8",...e},r?.(e,U.schema.arguments),function(e){if("none"===e.encoding)e.pixels instanceof Uint8ClampedArray||(e.pixels=new Uint8ClampedArray(e.pixels));else if("base64"===e.encoding){const t=atob(e.pixels);switch(e.pixels=new Uint8ClampedArray(e.width*e.height*R),e.channels){case"rgba:8+8+8+8":n?.(t.length===e.width*e.height*R,"Unexpected data length for a Base64-encoded texture; expected 4 bytes per pixel.");for(let r=0;r<e.width*e.height*4;r++)e.pixels[r]=t.charCodeAt(r);break;case"rgba:5+5+5+1":{n?.(t.length===e.width*e.height*2,"Unexpected data length for a Base64-encoded texture; expected 2 bytes per pixel.");let r=0;for(let n=0;n<e.width*e.height*2;n+=2){const o=t.charCodeAt(n)+(t.charCodeAt(n+1)<<8);e.pixels[r++]=8*(31&o),e.pixels[r++]=8*(o>>5&31),e.pixels[r++]=8*(o>>10&31),e.pixels[r++]=255*(o>>15&1)}break}default:a("Unrecognized value for texture 'channels' attribute.")}}else"none"!==e.encoding&&a("Unknown texture data encoding '"+e.encoding+"'.");n?.(e.pixels.length===e.width*e.height*R,"The texture's pixel array size doesn't match its width and height.")}(e);const t={$constructor:"Texture",mipLevels:Y(e),...e};return r?.(t,U.schema.interface),t}function Y(e){const t=[];for(let r=0;;r++){const o=Math.max(1,Math.floor(e.width/Math.pow(2,r))),a=Math.max(1,Math.floor(e.height/Math.pow(2,r))),i=[];{const t=e.width/o,r=e.height/a;for(let n=0;n<a;n++)for(let a=0;a<o;a++){const l=(a+n*o)*R,s=(Math.floor(a*t)+Math.floor(n*r)*e.width)*R;for(let t=0;t<R;t++)i[l+t]=e.pixels[s+t]}}if(t.push({width:o,height:a,pixels:i}),1===o&&1===a){n?.(t.length>0,"Failed to generate mip levels for a texture.");break}}return t}U.schema={arguments:{where:"in arguments passed to texture()",allowAdditionalProperties:!0,properties:{pixels:[["number"],"string"],width:{type:["number"],value(e){if(e<1||e>32768)return"Texture width must be in the range [1, 32768]"}},height:{type:["number"],value(e){if(e<1||e>32768)return"Texture height must be in the range [1, 32768]"}},encoding:{type:["string"],value(e){const t=["none","base64"];if(!t.includes(e))return`Texture encoding must be one of ${t.join(", ")}`}},channels:{type:["string"],value(e){const t=["rgba:5+5+5+1","rgba:8+8+8+8"];if(!t.includes(e))return`Texture pixel layout must be one of ${t.join(", ")}`}}}},interface:{where:"in the return value of texture()",allowAdditionalProperties:!0,properties:{$constructor:{value:"Texture"},width:["number"],height:["number"],pixels:["Uint8ClampedArray"],mipLevels:[["object"]]}}},U.deep_copy=function(e){const t=new Array(e.width*e.height*4);for(let r=0;r<e.width*e.height*4;r++)t[r]=e.pixels[r];return U({...e,pixels:t})},U.load=function(e){return new Promise(((t,r)=>{fetch(e).then((e=>e.json())).then((e=>{t(U(e))})).catch((t=>{a(`Failed to create a texture with data from file '${e}'. Error: '${t}'.`)}))}))};const Z={version:{major:0,minor:1,patch:0,dev:!1},defaultPipeline:{rasterizer:_,surface_wiper:P,transform_clip_lighter:L},render:I,assert:n,$throw:a,lerp:o,bilinear_sample:function(e,t=.5,r=t){const n=o(e(0,0),e(0,1),r),a=o(e(1,0),e(1,1),r);return o(n,a,t)},log:function(e="Hello there."){console.log(e)},renderable_width_of:i,renderable_height_of:l,color:d,state:D,light:X,material:c,matrix44:C,mesh:V,ngon:h,surface:E,texture:U,trig:A,vector:s,vertex:u};var O=self;for(var F in t)O[F]=t[F];t.__esModule&&Object.defineProperty(O,"__esModule",{value:!0})})();